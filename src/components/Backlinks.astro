---
import { getStageData } from "../lib/theme";

interface Props {
    backlinkedNotes: any[];
}

const { backlinkedNotes: rawBacklinkedNotes } = Astro.props;

// Process notes for display (add displayDate, sort)
const backlinkedNotes = rawBacklinkedNotes
    .map((note) => {
        const displayDate = note.data.publishedDate || new Date();
        return { ...note, displayDate };
    })
    .sort((a, b) => b.displayDate.getTime() - a.displayDate.getTime()); // Most recent first
---

{
    backlinkedNotes.length > 0 && (
        <section class="pt-2 border-t border-slate-100 dark:border-slate-700">
            <div class="flex items-center gap-2 mb-6">
                <span class="material-symbols-outlined text-slate-400 translate-y-1/3 text-sm">link</span>
                <h3 class="text-xs font-bold uppercase tracking-[0.2em] text-slate-400">Associated Nodes</h3>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                {backlinkedNotes.map((note) => (
                    <article class="bg-white dark:bg-slate-800 p-6 rounded-xl border border-slate-200 dark:border-slate-700 shadow-sm group hover:shadow-md transition-all relative">
                        <div class="flex justify-between items-start mb-4">
                            <span class={`text-[10px] font-bold uppercase tracking-widest px-2 py-1 rounded ${getStageData(note.data.stage).colors.badge}`}>
                                {note.data.stage}
                            </span>
                            <span class="text-[10px] text-slate-400 font-medium">
                                {note.displayDate.toLocaleDateString("en-US", {
                                    month: 'short',
                                    day: 'numeric',
                                    year: 'numeric',
                                }).toUpperCase()}
                            </span>
                        </div>
                        <h4 class="text-xl mt-0 font-bold text-black dark:text-white mb-2 group-hover:text-blue-600 dark:group-hover:text-blue-400 transition-colors">
                            <a href={`/notes/${note.id.replace('.md', '')}`} class="after:absolute after:inset-0">
                                {note.data.title}
                            </a>
                        </h4>
                        {note.data.summary && (
                            <p class="text-sm text-slate-500 dark:text-slate-400 font-body line-clamp-2">
                                {note.data.summary}
                            </p>
                        )}
                    </article>
                ))}
            </div>
        </section>
    )
}
