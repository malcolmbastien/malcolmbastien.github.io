---
import { getStageData } from "../lib/theme";

interface Props {
    backlinkedNotes: any[];
}

const { backlinkedNotes: rawBacklinkedNotes } = Astro.props;

const backlinkedNotes = rawBacklinkedNotes
    .map((note) => {
        const displayDate = note.data.publishedDate || new Date();
        return { ...note, displayDate };
    })
    .sort((a, b) => b.displayDate.getTime() - a.displayDate.getTime());

const getStageBadgeClass = (stage: string) => {
    switch (stage) {
        case 'seed':
            return 'bg-amber-100 text-amber-700 dark:bg-amber-900/30 dark:text-amber-400';
        case 'sprout':
            return 'bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-400';
        case 'evergreen':
            return 'bg-emerald-600 text-white';
        default:
            return 'bg-slate-100 text-slate-700';
    }
};
---

{
    backlinkedNotes.length > 0 && (
        <section>
            <div class="flex items-center gap-3 mb-8">
                <h3 class="small-caps text-xs font-bold tracking-[0.2em] text-slate-500">Connected Notes</h3>
                <div class="h-px bg-slate-100 dark:bg-slate-800 grow"></div>
                <span class="text-[10px] font-medium text-slate-400">{backlinkedNotes.length} links</span>
            </div>
            
            <div class="space-y-6">
                {backlinkedNotes.map((note) => (
                    <article class="group relative p-6 border-b border-slate-100 dark:border-slate-800 hover:bg-slate-50/50 dark:hover:bg-slate-800/30 transition-colors">
                        <div class="flex items-center gap-3 mb-3">
                            <span class={`text-[10px] font-bold px-2 py-0.5 rounded uppercase tracking-wider ${getStageBadgeClass(note.data.stage)}`}>
                                {note.data.stage}
                            </span>
                            <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">
                                {note.displayDate.toLocaleDateString("en-US", {
                                    month: 'short',
                                    day: 'numeric',
                                    year: 'numeric',
                                })}
                            </span>
                        </div>
                        
                        <h4 class="text-xl font-bold text-slate-900 dark:text-white mb-2 group-hover:text-primary dark:group-hover:text-blue-400 transition-colors">
                            <a href={`/notes/${note.id.replace('.md', '')}`}>
                                {note.data.title}
                            </a>
                        </h4>
                        
                        {note.data.summary && (
                            <p class="text-sm text-slate-600 dark:text-slate-400 line-clamp-2">
                                {note.data.summary}
                            </p>
                        )}
                    </article>
                ))}
            </div>
        </section>
    )
}
