---
import { getStageColors } from "../lib/theme";

interface Props {
    backlinkedNotes: any[];
}

const { backlinkedNotes: rawBacklinkedNotes } = Astro.props;

// Process notes for display (add displayDate, sort)
const backlinkedNotes = rawBacklinkedNotes
    .map((note) => {
        const displayDate = note.data.publishedDate || new Date();
        return { ...note, displayDate };
    })
    .sort((a, b) => b.displayDate.getTime() - a.displayDate.getTime()); // Most recent first

const stageColors = getStageColors();

const formatDate = (date: Date) => {
    return date.toLocaleDateString("en-US", {
        year: "numeric",
        month: "long",
        day: "numeric",
    });
};
---

{
    backlinkedNotes.length > 0 && (
        <section class="mt-20 pt-14 border-t border-slate-100">
            <h3 class="metadata text-xs font-bold text-slate-500 dark:text-slate-400 mb-10 uppercase tracking-[0.2em]">
                Associated Nodes
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                {backlinkedNotes.map((note) => (
                    <a
                        href={`/notes/${note.id.replace('.md', '')}`}
                        class="card-blueprint group block p-8 bg-white hover:shadow-[6px_6px_0_0_#f1f5f9]"
                    >
                        <div class="flex items-center gap-3 mb-5">
                            <span
                                class={`metadata text-xs font-bold ${note.data.stage === 'evergreen' ? 'text-andon-emerald' : 'text-andon-amber'}`}
                            >
                                {note.data.stage.toUpperCase()}
                            </span>
                        </div>
                        <h4 class="text-xl font-bold text-terminal-dark group-hover:text-blueprint-blue transition-colors mb-3 line-clamp-2 tracking-tight">
                            {note.data.title}
                        </h4>
                        <p class="text-xs font-sans text-slate-500 line-clamp-2 mb-6 leading-relaxed">
                            {note.data.summary}
                        </p>
                        <div class="metadata text-xs text-slate-500 dark:text-slate-400 font-mono">
                            <time datetime={note.displayDate.toISOString()}>
                                {note.displayDate.toLocaleDateString("en-US", {
                                    month: 'short',
                                    day: 'numeric',
                                    year: 'numeric',
                                }).toUpperCase()}
                            </time>
                        </div>
                    </a>
                ))}
            </div>
        </section>
    )
}
