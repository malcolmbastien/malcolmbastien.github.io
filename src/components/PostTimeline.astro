---
import { getStatusColors } from "../lib/theme";

interface Props {
    sortedEvents: Array<{
        type: string;
        post: any;
        date: Date;
        title: string;
        count?: number;
    }>;
    allMonths: Array<{
        key: string;
        date: Date;
        hasActivity: boolean;
    }>;
    eventsByMonthKey: Map<string, any[]>;
}

const { sortedEvents, allMonths, eventsByMonthKey } = Astro.props;
const statusColors = getStatusColors();

// Find the index of the first month with activity (most recent)
const firstActiveMonthIndex = allMonths.findIndex((m) => m.hasActivity);

// If there's a month with activity, show it first. Otherwise show first month.
const initialVisibleMonth =
    firstActiveMonthIndex !== -1
        ? allMonths[firstActiveMonthIndex]
        : allMonths.length > 0
          ? allMonths[0]
          : null;

// All months after the initial visible one go to hidden container
const startIndex = initialVisibleMonth
    ? allMonths.findIndex((m) => m.key === initialVisibleMonth.key) + 1
    : 0;
const hiddenMonths = allMonths.slice(startIndex);
---

<div class="timeline max-w-4xl mx-auto" id="timeline">
    {
        (() => {
            const now = new Date();

            const renderMonthSection = (
                monthKey: string,
                monthEvents: any[] | null,
            ) => {
                return (
                    <div class="month-section" data-month={monthKey}>
                        {/* Month header */}
                        <div class="month-divider py-2">
                            <h3 class="text-lg font-bold text-slate-900 dark:text-slate-100">
                                {monthKey}
                            </h3>
                        </div>

                        {monthEvents && monthEvents.length > 0 ? (
                            /* Events for this month */
                            <div class="month-events space-y-2">
                                {monthEvents.map((event: any) => {
                                    const diffMs =
                                        now.getTime() - event.date.getTime();
                                    const diffDays = Math.floor(
                                        diffMs / (1000 * 60 * 60 * 24),
                                    );
                                    const diffHours = Math.floor(
                                        diffMs / (1000 * 60 * 60),
                                    );
                                    const diffMinutes = Math.floor(
                                        diffMs / (1000 * 60),
                                    );

                                    const timeAgo =
                                        diffDays > 7
                                            ? event.date.toLocaleDateString(
                                                  "en-US",
                                                  {
                                                      month: "short",
                                                      day: "numeric",
                                                  },
                                              )
                                            : diffDays > 0
                                              ? `${diffDays} day${
                                                    diffDays > 1 ? "s" : ""
                                                } ago`
                                              : diffHours > 0
                                                ? `${diffHours} hour${
                                                      diffHours > 1 ? "s" : ""
                                                  } ago`
                                                : diffMinutes > 0
                                                  ? `${diffMinutes} minute${
                                                        diffMinutes > 1
                                                            ? "s"
                                                            : ""
                                                    } ago`
                                                  : "Just now";
                                    const icon =
                                        event.type === "created" ? "‚ûï" : "‚úèÔ∏è";

                                    return (
                                        <div
                                            class="timeline-event flex items-start gap-4 p-4 bg-white dark:bg-[#121812] border border-slate-200 dark:border-slate-800 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-800/50 transition-colors relative z-10"
                                            data-status={event.post.data.status}
                                            data-title={event.title.toLowerCase()}
                                            data-summary={
                                                event.post.data.summary?.toLowerCase() ||
                                                ""
                                            }
                                            data-tags={event.post.data.tags
                                                .join(" ")
                                                .toLowerCase()}
                                            data-created={
                                                event.date
                                                    .toISOString()
                                                    .split("T")[0]
                                            }
                                            data-updated={
                                                event.post.updatedDate
                                                    .toISOString()
                                                    .split("T")[0]
                                            }
                                            data-event-year={event.date.getFullYear().toString()}
                                            data-event-type={event.type}
                                        >
                                            <div class="shrink-0 w-10 h-10 rounded-full bg-slate-100 dark:bg-slate-800 flex items-center justify-center text-xl">
                                                {icon}
                                            </div>
                                            <div class="flex-1 min-w-0">
                                                <div class="flex items-center gap-2 mb-2">
                                                    <span
                                                        class={`px-2 py-0.5 rounded text-xs font-medium ${
                                                            event.type ===
                                                            "created"
                                                                ? "bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400"
                                                                : "bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-400"
                                                        }`}
                                                    >
                                                        {event.type ===
                                                        "created"
                                                            ? "Created"
                                                            : "Updated"}
                                                        {event.count
                                                            ? ` (${event.count})`
                                                            : ""}
                                                    </span>
                                                </div>
                                                <h4 class="font-semibold text-slate-900 dark:text-slate-100 mb-1">
                                                    <a
                                                        href={`/posts/${event.post.slug}`}
                                                        class="hover:text-emerald-600 dark:hover:text-emerald-400 transition-colors"
                                                    >
                                                        {event.title}
                                                    </a>
                                                </h4>
                                                <p class="text-sm text-slate-600 dark:text-slate-400 line-clamp-2">
                                                    {event.post.data.summary ||
                                                        ""}
                                                </p>
                                                <div class="flex items-center gap-2 mt-2">
                                                    <span
                                                        class={`px-1.5 py-0.5 rounded text-xs ${statusColors[event.post.data.status as keyof typeof statusColors]}`}
                                                    >
                                                        {event.post.data
                                                            .status === "seed"
                                                            ? "üå±"
                                                            : event.post.data
                                                                    .status ===
                                                                "sprout"
                                                              ? "üåø"
                                                              : "üå≥"}{" "}
                                                        {event.post.data.status}
                                                    </span>
                                                    <div class="flex flex-wrap gap-1">
                                                        {event.post.data.tags
                                                            .slice(0, 2)
                                                            .map(
                                                                (
                                                                    tag: string,
                                                                ) => (
                                                                    <span class="text-xs text-slate-500 dark:text-slate-400">
                                                                        {"#" +
                                                                            tag}
                                                                    </span>
                                                                ),
                                                            )}
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="shrink-0 w-24 flex flex-col items-end gap-1">
                                                <time
                                                    class="text-sm text-slate-500 dark:text-slate-400 text-right"
                                                    title={event.date.toLocaleString()}
                                                >
                                                    {timeAgo}
                                                </time>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        ) : (
                            /* No activity message */
                            <div class="month-no-activity p-6 text-center bg-slate-50 dark:bg-slate-800/50 rounded-lg border border-dashed border-slate-300 dark:border-slate-700">
                                <p class="text-sm text-slate-600 dark:text-slate-400 italic">
                                    There was no activity during this period.
                                </p>
                            </div>
                        )}
                    </div>
                );
            };

            // Render only the most recent month with activity initially
            if (initialVisibleMonth) {
                const monthEvents =
                    eventsByMonthKey.get(initialVisibleMonth.key) ?? null;
                return renderMonthSection(initialVisibleMonth.key, monthEvents);
            }

            // If no months at all, show empty state
            if (allMonths.length === 0) {
                return (
                    <div class="text-center py-12">
                        <p class="text-slate-600 dark:text-slate-400">
                            No posts in the garden yet.
                        </p>
                    </div>
                );
            }

            return null;
        })()
    }

    {/* Hidden month sections for "show more" functionality */}
    <div id="hidden-months" class="hidden">
        {
            hiddenMonths.map((month) => {
                const monthEvents = eventsByMonthKey.get(month.key) ?? null;
                const monthKey = month.key;
                const now = new Date();

                return (
                    <div
                        class="month-section hidden-month"
                        data-month={monthKey}
                    >
                        {/* Month header */}
                        <div class="month-divider py-2">
                            <h3 class="text-lg font-bold text-slate-900 dark:text-slate-100">
                                {monthKey}
                            </h3>
                        </div>

                        {monthEvents && monthEvents.length > 0 ? (
                            /* Events for this month */
                            <div class="month-events space-y-2">
                                {monthEvents.map((event: any) => {
                                    const diffMs =
                                        now.getTime() - event.date.getTime();
                                    const diffDays = Math.floor(
                                        diffMs / (1000 * 60 * 60 * 24),
                                    );
                                    const diffHours = Math.floor(
                                        diffMs / (1000 * 60 * 60),
                                    );
                                    const diffMinutes = Math.floor(
                                        diffMs / (1000 * 60),
                                    );

                                    const timeAgo =
                                        diffDays > 7
                                            ? event.date.toLocaleDateString(
                                                  "en-US",
                                                  {
                                                      month: "short",
                                                      day: "numeric",
                                                  },
                                              )
                                            : diffDays > 0
                                              ? `${diffDays} day${
                                                    diffDays > 1 ? "s" : ""
                                                } ago`
                                              : diffHours > 0
                                                ? `${diffHours} hour${
                                                      diffHours > 1 ? "s" : ""
                                                  } ago`
                                                : diffMinutes > 0
                                                  ? `${diffMinutes} minute${
                                                        diffMinutes > 1
                                                            ? "s"
                                                            : ""
                                                    } ago`
                                                  : "Just now";
                                    const icon =
                                        event.type === "created" ? "‚ûï" : "‚úèÔ∏è";

                                    return (
                                        <div
                                            class="timeline-event flex items-start gap-4 p-4 bg-white dark:bg-[#121812] border border-slate-200 dark:border-slate-800 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-800/50 transition-colors relative z-10"
                                            data-status={event.post.data.status}
                                            data-title={event.title.toLowerCase()}
                                            data-summary={
                                                event.post.data.summary?.toLowerCase() ||
                                                ""
                                            }
                                            data-tags={event.post.data.tags
                                                .join(" ")
                                                .toLowerCase()}
                                            data-created={
                                                event.date
                                                    .toISOString()
                                                    .split("T")[0]
                                            }
                                            data-updated={
                                                event.post.updatedDate
                                                    .toISOString()
                                                    .split("T")[0]
                                            }
                                            data-event-year={event.date.getFullYear().toString()}
                                            data-event-type={event.type}
                                        >
                                            <div class="shrink-0 w-10 h-10 rounded-full bg-slate-100 dark:bg-slate-800 flex items-center justify-center text-xl">
                                                {icon}
                                            </div>
                                            <div class="flex-1 min-w-0">
                                                <div class="flex items-center gap-2 mb-2">
                                                    <span
                                                        class={`px-2 py-0.5 rounded text-xs font-medium ${
                                                            event.type ===
                                                            "created"
                                                                ? "bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400"
                                                                : "bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-400"
                                                        }`}
                                                    >
                                                        {event.type ===
                                                        "created"
                                                            ? "Created"
                                                            : "Updated"}
                                                        {event.count
                                                            ? ` (${event.count})`
                                                            : ""}
                                                    </span>
                                                </div>
                                                <h4 class="font-semibold text-slate-900 dark:text-slate-100 mb-1">
                                                    <a
                                                        href={`/posts/${event.post.slug}`}
                                                        class="hover:text-emerald-600 dark:hover:text-emerald-400 transition-colors"
                                                    >
                                                        {event.title}
                                                    </a>
                                                </h4>
                                                <p class="text-sm text-slate-600 dark:text-slate-400 line-clamp-2">
                                                    {event.post.data.summary ||
                                                        ""}
                                                </p>
                                                <div class="flex items-center gap-2 mt-2">
                                                    <span
                                                        class={`px-1.5 py-0.5 rounded text-xs ${statusColors[event.post.data.status as keyof typeof statusColors]}`}
                                                    >
                                                        {event.post.data
                                                            .status === "seed"
                                                            ? "üå±"
                                                            : event.post.data
                                                                    .status ===
                                                                "sprout"
                                                              ? "üåø"
                                                              : "üå≥"}{" "}
                                                        {event.post.data.status}
                                                    </span>
                                                    <div class="flex flex-wrap gap-1">
                                                        {event.post.data.tags
                                                            .slice(0, 2)
                                                            .map(
                                                                (
                                                                    tag: string,
                                                                ) => (
                                                                    <span class="text-xs text-slate-500 dark:text-slate-400">
                                                                        {"#" +
                                                                            tag}
                                                                    </span>
                                                                ),
                                                            )}
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="shrink-0 w-24 flex flex-col items-end gap-1">
                                                <time
                                                    class="text-sm text-slate-500 dark:text-slate-400 text-right"
                                                    title={event.date.toLocaleString()}
                                                >
                                                    {timeAgo}
                                                </time>
                                                {event.type === "updated" && (
                                                    <div class="flex items-center gap-1">
                                                        <div class="w-16 h-1 bg-slate-200 dark:bg-slate-700 rounded-full overflow-hidden">
                                                            <div
                                                                class="h-full bg-blue-500 rounded-full"
                                                                style={`width: ${Math.min(
                                                                    100,
                                                                    ((event.post
                                                                        .data
                                                                        .summary
                                                                        ?.length ||
                                                                        0) /
                                                                        200) *
                                                                        100,
                                                                )}%`}
                                                            />
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        ) : (
                            /* No activity message */
                            <div class="month-no-activity p-6 text-center bg-slate-50 dark:bg-slate-800/50 rounded-lg border border-dashed border-slate-300 dark:border-slate-700">
                                <p class="text-sm text-slate-600 dark:text-slate-400 italic">
                                    There was no activity during this period.
                                </p>
                            </div>
                        )}
                    </div>
                );
            })
        }
    </div>

    {/* Show more activity button */}
    <div class="text-center mt-8">
        <button
            id="show-more-activity"
            class="px-6 py-3 bg-emerald-500 hover:bg-emerald-600 text-white font-medium rounded-lg transition-colors"
        >
            Show more activity
        </button>
    </div>
</div>

<script>
    const showMoreButton = document.getElementById("show-more-activity");
    const hiddenMonthsContainer = document.getElementById("hidden-months");
    const timeline = document.getElementById("timeline");

    if (showMoreButton && hiddenMonthsContainer && timeline) {
        let monthsShown = 0;
        const hiddenMonths = Array.from(hiddenMonthsContainer.children);

        // If no hidden months, hide button immediately
        if (!hiddenMonths || hiddenMonths.length === 0) {
            showMoreButton.style.display = "none";
        }

        showMoreButton.addEventListener("click", () => {
            if (monthsShown < hiddenMonths.length) {
                const nextMonth = hiddenMonths[monthsShown];

                // Show the month by appending it to the main timeline
                timeline.insertBefore(nextMonth, showMoreButton.parentElement);

                monthsShown++;

                // If no more hidden months, hide the button
                if (monthsShown >= hiddenMonths.length) {
                    showMoreButton.style.display = "none";
                }

                // Trigger updateDisplay to apply any active filters to newly revealed content
                const updateDisplayEvent = new CustomEvent(
                    "updateDisplayNeeded",
                );
                window.dispatchEvent(updateDisplayEvent);
            }
        });
    }
</script>

<style>
    .hidden-month {
        display: none;
    }
    .month-no-activity {
        border: 2px dashed rgb(203 213 225);
    }
    .dark .month-no-activity {
        border-color: rgb(71 85 105);
    }
</style>
