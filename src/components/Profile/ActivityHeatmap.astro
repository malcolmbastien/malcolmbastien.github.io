---
interface Props {
    year: number;
}

const { year } = Astro.props;

import { getPostsCommits } from "../../lib/git-history";

const commits = await getPostsCommits();
const commitDates = commits.map(
    (c) => new Date(c.date).toISOString().split("T")[0],
);

// Count commits per day
const activityMap: Record<string, number> = {};
commitDates.forEach((date) => {
    activityMap[date] = (activityMap[date] || 0) + 1;
});

interface DayData {
    date: string;
    count: number;
}

interface MonthLabel {
    name: string;
    weekIndex: number;
}

// Generate all days for the specified year (January 1 to December 31)
const days: DayData[] = [];
const startDate = new Date(year, 0, 1); // January 1st
const endDate = new Date(year, 11, 31); // December 31st

for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
    const dateStr = d.toISOString().split("T")[0];
    days.push({
        date: dateStr,
        count: activityMap[dateStr] || 0,
    });
}

// Generate month labels for the year
const monthLabels: MonthLabel[] = [];
let lastMonth = "";
for (let i = 0; i < days.length; i++) {
    const d = new Date(days[i].date);
    const monthKey = d.toLocaleDateString("en-US", { month: "short" });
    if (monthKey !== lastMonth) {
        const weekIndex = Math.floor(i / 7);
        // Only include months that are actually in this year and not too close to end
        if (d.getFullYear() === year && weekIndex < 50) {
            monthLabels.push({
                name: monthKey,
                weekIndex: weekIndex,
            });
        }
        lastMonth = monthKey;
    }
}

function getColor(count: number) {
    if (count === 0) return "fill-slate-100 dark:fill-[#1a241a]";
    if (count === 1) return "fill-emerald-200 dark:fill-emerald-900/40";
    if (count === 2) return "fill-emerald-400 dark:fill-emerald-700";
    if (count >= 3) return "fill-emerald-600 dark:fill-emerald-500";
    return "fill-slate-100 dark:fill-[#1a241a]";
}
---

<div
    class="bg-white dark:bg-[#121812] border border-slate-200 dark:border-slate-800 rounded-xl p-4 mb-2"
>
    <h3 class="text-sm font-semibold text-slate-900 dark:text-slate-100 mb-4">
        Activity
    </h3>
    <div class="overflow-x-auto">
        <svg
            width="720"
            height="112"
            class="mx-auto activity-heatmap-svg"
        >
            {
                monthLabels.map((label) => (
                    <text
                        x={label.weekIndex * 12 + 6}
                        y="10"
                        text-anchor="middle"
                        class="fill-slate-500 dark:fill-slate-400 text-[10px] font-medium"
                    >
                        {label.name}
                    </text>
                ))
            }
            {
                Array.from({ length: Math.ceil(days.length / 7) }).map((_, weekIndex) => (
                    <g transform={`translate(${weekIndex * 12}, 18)`}>
                        {Array.from({ length: 7 }).map((_, dayIndex) => {
                            const dayData = days[weekIndex * 7 + dayIndex];
                            if (!dayData) return null;
                            return (
                                <rect
                                    x="0"
                                    y={dayIndex * 12}
                                    width="10"
                                    height="10"
                                    rx="2"
                                    class={`${getColor(dayData.count)} transition-colors duration-300 hover:stroke-slate-400 dark:hover:stroke-slate-500 hover:stroke-1 ${dayData.count > 0 ? "cursor-pointer" : ""}`}
                                    data-date={dayData.date}
                                    data-count={dayData.count}
                                    onclick={
                                        dayData.count > 0
                                            ? `filterByDate('${dayData.date}')`
                                            : undefined
                                    }
                                />
                            );
                        })}
                    </g>
                ))
            }
        </svg>
    </div>
    <div
        class="mt-4 flex items-center justify-end gap-2 text-[10px] text-slate-400 uppercase tracking-widest"
    >
        <span>Less</span>
        <div class="w-3 h-3 bg-slate-100 dark:bg-[#1a241a] rounded-xs"></div>
        <div class="w-3 h-3 bg-emerald-200 dark:bg-emerald-900/40 rounded-xs">
        </div>
        <div class="w-3 h-3 bg-emerald-400 dark:bg-emerald-700 rounded-xs">
        </div>
        <div class="w-3 h-3 bg-emerald-600 dark:bg-emerald-500 rounded-xs">
        </div>
        <span>More</span>
    </div>

    <script define:vars={{ commits, year }}>
        // Store the currently selected date and year
        let selectedDate = null;
        let currentYear = year;

        // Function to update heatmap for a specific year
        window.updateHeatmapYear = function (newYear) {
            if (currentYear === newYear) return;
            currentYear = newYear;

            // Generate new data for the year
            const activityMap = {};
            commits.forEach((c) => {
                const commitYear = new Date(c.date).getFullYear();
                if (commitYear === newYear) {
                    const dateStr = new Date(c.date).toISOString().split("T")[0];
                    activityMap[dateStr] = (activityMap[dateStr] || 0) + 1;
                }
            });

            // Generate all days for the year
            const days = [];
            const startDate = new Date(newYear, 0, 1);
            const endDate = new Date(newYear, 11, 31);

            for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                const dateStr = d.toISOString().split("T")[0];
                days.push({
                    date: dateStr,
                    count: activityMap[dateStr] || 0,
                });
            }

            // Update SVG
            const svg = document.querySelector('.activity-heatmap-svg');
            if (!svg) return;

            // Clear existing content
            svg.innerHTML = '';

            // Add month labels
            const monthLabels = [];
            let lastMonth = "";
            for (let i = 0; i < days.length; i++) {
                const d = new Date(days[i].date);
                const monthKey = d.toLocaleDateString("en-US", { month: "short" });
                if (monthKey !== lastMonth) {
                    const weekIndex = Math.floor(i / 7);
                    // Only include months that are actually in this year and not too close to end
                    if (d.getFullYear() === newYear && weekIndex < 50) {
                        monthLabels.push({
                            name: monthKey,
                            weekIndex: weekIndex,
                        });
                    }
                    lastMonth = monthKey;
                }
            }

            // Add month labels to SVG
            monthLabels.forEach((label) => {
                const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                text.setAttribute('x', String(label.weekIndex * 12 + 6));
                text.setAttribute('y', '10');
                text.setAttribute('text-anchor', 'middle');
                text.className = 'fill-slate-500 dark:fill-slate-400 text-[10px] font-medium';
                text.textContent = label.name;
                svg.appendChild(text);
            });

            // Add day rectangles
            const numWeeks = Math.ceil(days.length / 7);
            for (let weekIndex = 0; weekIndex < numWeeks; weekIndex++) {
                const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                g.setAttribute('transform', `translate(${weekIndex * 12}, 18)`);

                for (let dayIndex = 0; dayIndex < 7; dayIndex++) {
                    const dayData = days[weekIndex * 7 + dayIndex];
                    if (!dayData) continue;

                    const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                    rect.setAttribute('x', '0');
                    rect.setAttribute('y', String(dayIndex * 12));
                    rect.setAttribute('width', '10');
                    rect.setAttribute('height', '10');
                    rect.setAttribute('rx', '2');
                    rect.setAttribute('data-date', dayData.date);
                    rect.setAttribute('data-count', String(dayData.count));

                    const colorClass = getColor(dayData.count);
                    rect.className = `${colorClass} transition-colors duration-300 hover:stroke-slate-400 dark:hover:stroke-slate-500 hover:stroke-1 ${dayData.count > 0 ? "cursor-pointer" : ""} activity-day`;

                    if (dayData.count > 0) {
                        rect.onclick = () => filterByDate(dayData.date);
                    }

                    g.appendChild(rect);
                }

                svg.appendChild(g);
            }
        };

        // Function to filter posts by date
        function filterByDate(dateString) {
            // If clicking the same date, clear the filter
            if (selectedDate === dateString) {
                selectedDate = null;
                // Clear any existing date filters
                const event = new CustomEvent("dateFilterChange", {
                    detail: { date: null },
                });
                window.dispatchEvent(event);
                // Reset visual feedback
                document
                    .querySelectorAll(".activity-day.selected")
                    .forEach((el) => {
                        el.classList.remove("selected");
                    });
                return;
            }

            selectedDate = dateString;

            // Dispatch custom event to notify the main filtering system
            const event = new CustomEvent("dateFilterChange", {
                detail: { date: dateString },
            });
            window.dispatchEvent(event);

            // Add visual feedback to selected day
            document
                .querySelectorAll(".activity-day.selected")
                .forEach((el) => {
                    el.classList.remove("selected");
                });

            // Find and highlight the clicked day
            const clickedDay = document.querySelector(
                `[data-date="${dateString}"]`,
            );
            if (clickedDay) {
                clickedDay.classList.add("selected");
            }
        }

        // Add selected class styling
        const style = document.createElement("style");
        style.textContent = `
			.activity-day.selected {
				stroke: #2563eb !important;
				stroke-width: 2px !important;
			}
			.dark .activity-day.selected {
				stroke: #3b82f6 !important;
			}
		`;
        document.head.appendChild(style);
    </script>
</div>
