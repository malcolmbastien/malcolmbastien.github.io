---
import { getAllCommits } from '../../lib/git-history';

const commits = await getAllCommits();
const commitDates = commits.map(c => new Date(c.date).toISOString().split('T')[0]);

// Count commits per day
const activityMap: Record<string, number> = {};
commitDates.forEach(date => {
	activityMap[date] = (activityMap[date] || 0) + 1;
});

interface DayData {
	date: string;
	count: number;
}

// Generate last 365 days
const today = new Date();
const days: DayData[] = [];
for (let i = 364; i >= 0; i--) {
	const d = new Date(today);
	d.setDate(d.getDate() - i);
	const dateStr = d.toISOString().split('T')[0];
	days.push({
		date: dateStr,
		count: activityMap[dateStr] || 0
	});
}

function getColor(count: number) {
	if (count === 0) return 'fill-slate-100';
	if (count === 1) return 'fill-emerald-200';
	if (count === 2) return 'fill-emerald-400';
	if (count >= 3) return 'fill-emerald-600';
	return 'fill-slate-100';
}
---

<div class="bg-white border border-slate-200 rounded-xl p-6 mb-12">
	<h3 class="text-sm font-semibold text-slate-900 mb-4">Activity Evolution</h3>
	<div class="overflow-x-auto">
		<svg width="720" height="110" class="mx-auto">
			{Array.from({ length: 52 }).map((_, weekIndex) => (
				<g transform={`translate(${weekIndex * 14}, 0)`}>
					{Array.from({ length: 7 }).map((_, dayIndex) => {
						const dayData = days[weekIndex * 7 + dayIndex];
						if (!dayData) return null;
						return (
							<rect
								x="0"
								y={dayIndex * 14}
								width="11"
								height="11"
								rx="2"
								class={`${getColor(dayData.count)} transition-colors duration-300 hover:stroke-slate-400 hover:stroke-1`}
								data-date={dayData.date}
								data-count={dayData.count}
							/>
						);
					})}
				</g>
			))}
		</svg>
	</div>
	<div class="mt-4 flex items-center justify-end gap-2 text-[10px] text-slate-400 uppercase tracking-widest">
		<span>Less</span>
		<div class="w-3 h-3 bg-slate-100 rounded-[2px]"></div>
		<div class="w-3 h-3 bg-emerald-200 rounded-[2px]"></div>
		<div class="w-3 h-3 bg-emerald-400 rounded-[2px]"></div>
		<div class="w-3 h-3 bg-emerald-600 rounded-[2px]"></div>
		<span>More</span>
	</div>
</div>
