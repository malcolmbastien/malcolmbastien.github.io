---
import { getFileHistory } from "../../lib/git-history";

interface Props {
    filePath: string;
}

const { filePath } = Astro.props;
const history = await getFileHistory(filePath);

function getEvolutionLabel(commit: any, index: number, total: number) {
    const isFirst = index === total - 1;
    if (isFirst) return "CREATED";

    const { insertions, deletions, message } = commit;
    const totalChange = insertions + deletions;
    const msg = message.toLowerCase();

    // Check for polish/minor tweaks
    if (msg.includes("typo") || msg.includes("grammar") || (totalChange > 0 && totalChange < 5)) return "POLISHED";

    if (insertions > 40) return "EXPANDED";
    if (insertions > 15) return "ADDED";
    if (deletions > 20) return "CONDENSED";

    return "UPDATED";
}
---

<div class="space-y-6 font-mono text-xs text-slate-500 dark:text-slate-400">
    {
        history.length > 0 ? (
            <div class="space-y-4">
                {history.map((commit: any, index: number) => (
                    <div class="flex flex-col md:flex-row md:items-center gap-2 md:gap-4 group">
                        <div class="shrink-0 font-bold uppercase tracking-widest text-slate-400 whitespace-nowrap">
                            {new Date(commit.date).toLocaleDateString("en-US", { year: 'numeric', month: 'short', day: '2-digit' })}
                        </div>
                        <div class="shrink-0 text-blue-500 font-bold w-20">
                            {getEvolutionLabel(commit, index, history.length)}
                        </div>
                        <div class="flex-1 truncate group-hover:text-blue-500 dark:group-hover:text-white transition-colors">
                            {commit.message}
                        </div>
                        <div class="shrink-0 flex items-center gap-3">
                            <div class="flex gap-2">
                                <span class="text-green-600 dark:text-green-600">+{commit.insertions}</span>
                                <span class="text-rose-400">-{commit.deletions}</span>
                            </div>
                            <a
                                href={`https://github.com/malcolmbastien/malcolmbastien.github.io/commit/${commit.hash}`}
                                target="_blank"
                                rel="noopener noreferrer"
                                class="text-slate-400 hover:text-blue-500 dark:hover:text-white transition-colors"
                            >
                                {commit.hash.substring(0, 7)}
                            </a>
                        </div>
                    </div>
                ))}
            </div>
        ) : (
            <p class="italic">
                No history recorded for this note
            </p>
        )
    }
</div>
