---
import { getFileHistory } from "../../lib/git-history";

interface Props {
    filePath: string;
}

const { filePath } = Astro.props;
const history = await getFileHistory(filePath);

function getEvolutionLabel(commit: any, index: number, total: number) {
    const isFirst = index === total - 1;
    if (isFirst) return "NODE_INIT";

    const { insertions, deletions, message } = commit;
    const totalChange = insertions + deletions;
    const netChange = insertions - deletions;
    const msg = message.toLowerCase();

    // Check for polish/minor tweaks
    if (msg.includes("typo") || msg.includes("grammar") || (totalChange > 0 && totalChange < 5)) return "REFINEMENT";
    
    if (insertions > 40) return "EXPANSION";
    if (insertions > 15) return "DATA_GROWTH";
    if (deletions > 20) return "PRUNING";
    
    return "MAINTENANCE";
}
---

<div class="space-y-6 font-mono text-sm text-slate-500 dark:text-slate-400">
    {
        history.length > 0 ? (
            <div class="space-y-4">
                {history.map((commit: any, index: number) => (
                    <div class="flex gap-4 group">
                        <div class="shrink-0 text-slate-500 dark:text-slate-400 w-16">
                            {new Date(commit.date).toLocaleDateString("en-US", { month: 'short', day: '2-digit' }).toUpperCase()}
                        </div>
                        <div class="shrink-0 text-blueprint-blue dark:text-blue-300 font-bold w-20">
                            [{getEvolutionLabel(commit, index, history.length)}]
                        </div>
                        <div class="flex-1 text-slate-500 dark:text-slate-400 truncate group-hover:text-terminal-dark dark:group-hover:text-white transition-colors">
                            {commit.message}
                        </div>
                        <div class="shrink-0 flex gap-3">
                            <div class="flex gap-1">
                                <span class="text-andon-emerald">+{commit.insertions}</span>
                                <span class="text-rose-400 dark:text-rose-300">-{commit.deletions}</span>
                            </div>
                            <a
                                href={`https://github.com/malcolmbastien/malcolmbastien.github.io/commit/${commit.hash}`}
                                target="_blank"
                                rel="noopener noreferrer"
                                class="text-slate-500 dark:text-slate-400 hover:text-blueprint-blue transition-colors"
                            >
                                {commit.hash.substring(0, 7)}
                            </a>
                        </div>
                    </div>
                ))}
            </div>
        ) : (
            <p class="text-slate-500 dark:text-slate-400 italic">
                NO_HISTORY_LOGGED_FOR_NODE
            </p>
        )
    }
</div>
