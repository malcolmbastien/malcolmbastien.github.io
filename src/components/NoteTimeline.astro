---
import { Image } from "astro:assets";

interface Props {
    sortedEvents: Array<{
        type: string;
        note: any;
        date: Date;
        title: string;
        count?: number;
    }>;
    allMonths: Array<{
        key: string;
        date: Date;
        hasActivity: boolean;
    }>;
    eventsByMonthKey: Map<string, any[]>;
    initialYear?: string;
}

const { sortedEvents, allMonths, eventsByMonthKey } = Astro.props;

// Pre-calculate which events are in the initial batch (first 10) for each year
// to allow for instant, flicker-free rendering via CSS.
const yearCounters = new Map<number, number>();
const eventBatchStatus = new Map<any, boolean>();

// We process events in the same order they appear in the timeline (sorted descending)
sortedEvents.forEach((event) => {
    const year = event.date.getFullYear();
    const count = yearCounters.get(year) || 0;
    eventBatchStatus.set(event, count < 10);
    yearCounters.set(year, count + 1);
});

const getStageColorClass = (stage: string) => {
    switch(stage) {
        case 'seed': return 'text-seed bg-amber-50 dark:bg-amber-900/30';
        case 'sprout': return 'text-sprout bg-blue-50 dark:bg-blue-900/30';
        case 'evergreen': return 'text-evergreen bg-emerald-50 dark:bg-emerald-900/30';
        default: return 'text-slate-400 bg-slate-50 dark:bg-slate-900/30';
    }
}
---

<div class="timeline space-y-12" id="timeline">
    {
        allMonths.map((month) => {
            const monthKey = month.key;
            const monthEvents = eventsByMonthKey.get(monthKey) ?? null;
            const monthYear = month.date.getFullYear().toString();

            return (
                <section
                    class="month-section space-y-10"
                    data-month={monthKey}
                    data-year={monthYear}
                >
                    {/* Month header */}
                    <div class="flex items-center gap-2 mb-8">
                        <div class="w-2 h-2 rounded-full bg-blue-500"></div>
                        <h2 class="text-xs font-bold uppercase tracking-[0.2em] text-slate-400">
                            {monthKey.toUpperCase()}
                        </h2>
                    </div>

                    {monthEvents && monthEvents.length > 0 ? (
                        /* Events for this month */
                        <div class="month-events space-y-10">
                             {monthEvents.map((event: any) => {
                                 const eventYear = event.date.getFullYear().toString();
                                 const isInitialBatch = eventBatchStatus.get(event);

                                   return (
                                              <article
                                                 class="timeline-event bg-white dark:bg-slate-800 p-8 rounded-xl border border-slate-200 dark:border-slate-700 shadow-sm hover:shadow-md transition-all group relative"
                                                data-stage={event.note.data.stage}
                                               data-title={event.title.toLowerCase()}
                                               data-summary={
                                                   event.note.data.summary?.toLowerCase() ||
                                                   ""
                                               }
                                               data-topics={event.note.data.tags
                                                   .join(" ")
                                                   .toLowerCase()}

                                              data-created={
                                                  event.date
                                                      .toISOString()
                                                      .split("T")[0]
                                              }
                                              data-event-year={eventYear}
                                              data-event-type={event.type}
                                              data-is-collapsed={event.isCollapsed ? "true" : "false"}
                                              data-is-initial-batch={isInitialBatch ? "true" : "false"}
                                            >
                                           <div class="flex justify-between items-start mb-4">
                                                <span class={`text-[10px] font-bold uppercase tracking-widest px-2 py-1 rounded ${getStageColorClass(event.note.data.stage)}`}>
                                                    {event.note.data.stage}
                                                </span>
                                                <span class="font-mono text-[10px] text-slate-400 uppercase">
                                                   {event.date.toLocaleDateString("en-US", { month: 'short', day: 'numeric' })}
                                               </span>
                                           </div>

                                            <h2 class="text-2xl font-bold text-black dark:text-white mb-4 group-hover:text-blue-600 dark:group-hover:text-blue-400 transition-colors">
                                               <a
                                                   href={`/notes/${event.note.id.replace('.md', '')}`}
                                                   class="after:absolute after:inset-0"
                                               >
                                                   {event.title}
                                               </a>
                                           </h2>

                                           {event.note.data.summary && (
                                               <p class="text-slate-600 dark:text-slate-400 font-body mb-6 leading-relaxed">
                                                   {event.note.data.summary}
                                               </p>
                                           )}

                                           {event.note.data.cover && (
                                                <div class="mb-6">
                                                    <Image
                                                        src={event.note.data.cover}
                                                        alt={event.note.data.coverImageAlt || event.title}
                                                        class="w-full h-auto rounded-lg border border-slate-100 dark:border-slate-700"
                                                    />
                                                </div>
                                            )}

                                            <div class="flex justify-between items-center">
                                                <div class="flex gap-3">
                                                    {event.note.data.tags.slice(0, 3).map((tag: string) => (
                                                        <span class="text-xs text-slate-400">#{tag}</span>
                                                    ))}
                                                </div>
                                                <span class="text-[10px] font-bold text-blue-500 dark:text-blue-400 uppercase tracking-widest bg-blue-50 dark:bg-blue-900/30 px-2 py-1 rounded">
                                                    {event.type.toUpperCase()}
                                                </span>
                                            </div>
                                       </article>
                                   );
                              })}
                        </div>
                      ) : (
                        /* No activity message */
                        <div class="p-10 text-center bg-slate-50 dark:bg-slate-900/50 border border-dashed border-slate-200 dark:border-slate-700 rounded-xl">
                            <p class="text-sm text-slate-400 tracking-widest uppercase">
                                No activity recorded
                            </p>
                        </div>
                    )}
                </section>
            );
        })
    }

    {/* No results message */}
    <div id="no-results" class="hidden text-center py-12">
        <p class="font-mono text-slate-500">
            No matching notes found
        </p>
    </div>

    {/* Show more activity button */}
    <div class="text-center pt-8">
        <button
            id="show-more-activity"
            class="px-8 py-3 bg-primary dark:bg-white text-white dark:text-primary font-bold text-xs uppercase tracking-widest rounded-full hover:shadow-lg transition-all active:scale-95 hidden"
        >
            Show more activity
        </button>
    </div>
</div>
