---
import { Image } from "astro:assets";

interface Props {
    sortedEvents: Array<{
        note: any;
        date: Date;
        title: string;
    }>;
    allMonths: Array<{
        key: string;
        date: Date;
        hasActivity: boolean;
    }>;
    eventsByMonthKey: Map<string, any[]>;
    initialYear?: string;
}

import { getStageData } from "../lib/theme";

const { sortedEvents, allMonths, eventsByMonthKey } = Astro.props;

// Pre-calculate which events are in the initial batch (first 10) for each year
const yearCounters = new Map<number, number>();
const eventBatchStatus = new Map<any, boolean>();

sortedEvents.forEach((event) => {
    const year = event.date.getFullYear();
    const count = yearCounters.get(year) || 0;
    eventBatchStatus.set(event, count < 10);
    yearCounters.set(year, count + 1);
});

// Helper to get stage badge styling
const getStageBadgeClass = (stage: string) => {
    const stageData = getStageData(stage);
    return stageData.colors.badge;
};
---

<div class="timeline" id="timeline">
    {
        allMonths.map((month) => {
            const monthKey = month.key;
            const monthEvents = eventsByMonthKey.get(monthKey) ?? null;
            const monthYear = month.date.getFullYear().toString();

            return (
                <section
                    class="month-section mb-12"
                    data-month={monthKey}
                    data-year={monthYear}
                >
                    {/* Month header with line */}
                    <div class="flex items-center gap-4 mb-8">
                        <h2 class="text-sm font-semibold text-stone-600">
                            {monthKey}
                        </h2>
                        <div class="h-px bg-stone-100 dark:bg-slate-800 grow"></div>
                        <span class="text-xs font-medium text-stone-400">
                            {monthEvents?.length || 0} {monthEvents?.length === 1 ? 'entry' : 'entries'}
                        </span>
                    </div>

                    {monthEvents && monthEvents.length > 0 ? (
                        /* Events for this month */
                        <div>
                             {monthEvents.map((event: any) => {
                                 const eventYear = event.date.getFullYear().toString();
                                 const isInitialBatch = eventBatchStatus.get(event);

                                    return (
                                         <a href={`/notes/${event.note.id.replace('.md', '')}`}
                                            class="timeline-event block py-6 px-6 border-b border-stone-100 dark:border-slate-800 hover:bg-stone-100 dark:hover:bg-slate-800 transition-colors group cursor-pointer"
                                            data-stage={event.note.data.stage}
                                            data-title={event.title.toLowerCase()}
                                            data-summary={
                                                event.note.data.summary?.toLowerCase() ||
                                                ""
                                            }
                                            data-topics={event.note.data.tags
                                                .join(" ")
                                                .toLowerCase()}
                                            data-created={
                                                event.date
                                                    .toISOString()
                                                    .split("T")[0]
                                            }
                                            data-event-year={eventYear}
                                            data-is-initial-batch={isInitialBatch ? "true" : "false"}
                                         >
                                             {/* Title - Primary */}
                                             <h3 class="text-3xl font-bold text-stone-900 dark:text-white mb-3 leading-tight group-hover:text-primary dark:group-hover:text-blue-400 transition-colors">
                                                 {event.title}
                                             </h3>

                                             {/* Meta row - Stage and Date as contextual */}
                                             <div class="flex items-center gap-2 mb-5 text-sm">
                                                 <span class={`font-medium ${event.note.data.stage === 'seed' ? 'text-orange-600 dark:text-orange-400' : event.note.data.stage === 'sprout' ? 'text-yellow-600 dark:text-yellow-400' : 'text-green-600 dark:text-green-400'}`}>
                                                     {event.note.data.stage.charAt(0).toUpperCase() + event.note.data.stage.slice(1)}
                                                 </span>
                                                 <span class="text-stone-300 dark:text-stone-600">Â·</span>
                                                 <span class="text-stone-500 dark:text-stone-400">
                                                     {event.date.toLocaleDateString("en-US", {
                                                         month: 'short',
                                                         day: 'numeric',
                                                         year: 'numeric',
                                                         timeZone: 'UTC'
                                                     })}
                                                 </span>
                                             </div>

                                             {/* Content wrapper - flex layout when featured with image */}
                                             <div class={`${event.note.data.cover ? 'flex flex-col md:flex-row md:gap-8' : ''}`}>
                                                 {/* Text content */}
                                                 <div class={`${event.note.data.cover ? 'flex-1' : ''}`}>

                                                     {/* Summary */}
                                                     {event.note.data.summary && (
                                                         <p class="text-stone-600 dark:text-stone-400 leading-relaxed max-w-2xl mb-6">
                                                             {event.note.data.summary}
                                                         </p>
                                                     )}
                                                 </div>

                                                 {/* Optional cover image - right side */}
                                                 {event.note.data.cover && (
                                                     <div class="md:w-64 lg:w-80 flex-shrink-0 mb-6 md:mb-0">
                                                         <Image
                                                             src={event.note.data.cover}
                                                             alt={event.note.data.coverImageAlt || event.title}
                                                             class="w-full h-auto rounded-xl"
                                                             width={320}
                                                             height={240}
                                                         />
                                                     </div>
                                                 )}
                                             </div>

                                            {/* Tags */}
                                            {event.note.data.tags.length > 0 && (
                                                <div class="flex gap-4 mt-6">
                                                    {event.note.data.tags.slice(0, 4).map((tag: string) => (
                                                        <span class="text-xs font-medium text-stone-400">#{tag}</span>
                                                    ))}
                                                </div>
                                            )}
                                        </a>
                                    );
                               })}
                        </div>
                      ) : (
                        /* No activity message */
                        <div class="py-12 text-center border-b border-stone-100 dark:border-slate-800">
                            <p class="text-xs font-medium text-stone-400">
                                No notes this month
                            </p>
                        </div>
                    )}
                </section>
            );
        })
    }

    {/* No results message */}
    <div id="no-results" class="hidden text-center py-16">
        <p class="text-stone-600 dark:text-stone-400 text-lg">
            No matching notes found
        </p>
    </div>
</div>
