---
import { Image } from "astro:assets";

interface Props {
    sortedEvents: Array<{
        type: string;
        note: any;
        date: Date;
        title: string;
        count?: number;
    }>;
    allMonths: Array<{
        key: string;
        date: Date;
        hasActivity: boolean;
    }>;
    eventsByMonthKey: Map<string, any[]>;
    initialYear?: string;
}

const { sortedEvents, allMonths, eventsByMonthKey } = Astro.props;

// Pre-calculate which events are in the initial batch (first 10) for each year
// to allow for instant, flicker-free rendering via CSS.
const yearCounters = new Map<number, number>();
const eventBatchStatus = new Map<any, boolean>();

// We process events in the same order they appear in the timeline (sorted descending)
sortedEvents.forEach((event) => {
    const year = event.date.getFullYear();
    const count = yearCounters.get(year) || 0;
    eventBatchStatus.set(event, count < 10);
    yearCounters.set(year, count + 1);
});
---

<div class="timeline max-w-4xl timeline-thread ml-2 md:ml-0" id="timeline">
    {
        allMonths.map((month) => {
            const monthKey = month.key;
            const monthEvents = eventsByMonthKey.get(monthKey) ?? null;
            const monthYear = month.date.getFullYear().toString();

            return (
                <div
                    class="month-section pb-16 last:pb-0"
                    data-month={monthKey}
                    data-year={monthYear}
                >
                    {/* Month header v1.1 */}
                    <div class="relative flex items-center gap-6 mb-8">
                        <div class="timeline-marker shrink-0"></div>
                        <h3 class="metadata text-xs font-bold text-primary tracking-[0.2em]">
                            {monthKey.toUpperCase()}
                        </h3>
                        <div class="flex-1 h-[1px] bg-slate-100 dark:bg-slate-800"></div>
                    </div>

                    {monthEvents && monthEvents.length > 0 ? (
                        /* Events for this month */
                        <div class="month-events space-y-6 ml-6 md:ml-9">
                             {monthEvents.map((event: any) => {
                                 const isFeatured = event.note.data.featured;
                                 const eventYear = event.date.getFullYear().toString();
                                 const isInitialBatch = eventBatchStatus.get(event);

                                  return (
                                             <div
                                                class={`timeline-event p-0 card-interactive cursor-pointer group overflow-hidden ${
                                                    isFeatured
                                                     ? "featured"
                                                     : ""
                                                }`}
                                               data-stage={event.note.data.stage}
                                               data-title={event.title.toLowerCase()}
                                               data-summary={
                                                   event.note.data.summary?.toLowerCase() ||
                                                   ""
                                               }
                                               data-topics={event.note.data.tags
                                                   .join(" ")
                                                   .toLowerCase()}

                                              data-created={
                                                  event.date
                                                      .toISOString()
                                                      .split("T")[0]
                                              }
                                              data-event-year={eventYear}
                                              data-event-type={event.type}
                                              data-is-collapsed={event.isCollapsed ? "true" : "false"}
                                              data-is-initial-batch={isInitialBatch ? "true" : "false"}
                                           >
                                          <div class="flex flex-col gap-5 p-7">
                                             <div class="flex justify-between items-center">
                                                   <span class={`metadata text-sm font-bold text-signal-${event.note.data.stage}`}>
                                                       {event.note.data.stage.toUpperCase()}
                                                   </span>
                                                   <time class="metadata-secondary text-xs">
                                                      {event.date.toLocaleDateString("en-US", { month: 'short', day: 'numeric' }).toUpperCase()}
                                                  </time>
                                             </div>

                                             <div class="flex-1 min-w-0">
                                                   <h4 class="text-2xl font-bold text-terminal-dark dark:text-neutral-text-dark mb-2 leading-tight group-hover:text-blueprint-blue transition-colors">
                                                      <a
                                                          href={`/notes/${event.note.id.replace('.md', '')}`}
                                                          class="after:absolute after:inset-0"
                                                      >
                                                          {event.title}
                                                      </a>
                                                  </h4>
                                                 {event.note.data.summary && (
                                                     <p class="text-lg text-secondary line-clamp-2 leading-relaxed">
                                                         {event.note.data.summary}
                                                     </p>
                                                 )}
                                             </div>

                                               <div class="flex items-center justify-between pt-4 border-t border-slate-50 dark:border-slate-800/50">
                                                   <div class="flex gap-3">
                                                       {event.note.data.tags.slice(0, 3).map((tag: string) => (
                                                           <span class="text-sm text-secondary">#{tag}</span>
                                                       ))}
                                                   </div>
                                                   {event.type === "created" ? (
                                                       <span class="inline-flex items-center px-2 py-1 text-xs font-bold rounded bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200">
                                                           CREATED
                                                       </span>
                                                   ) : (
                                                       <span class="inline-flex items-center px-2 py-1 text-xs font-bold rounded bg-amber-100 dark:bg-amber-900 text-amber-800 dark:text-amber-200">
                                                           UPDATED
                                                       </span>
                                                   )}
                                               </div>
                                          </div>
                                           {isFeatured && event.note.data.cover && (
                                               <a href={`/notes/${event.note.id.replace('.md', '')}`} class="block">
                                                   <div class="w-full h-48 overflow-hidden">
                                                       <Image
                                                           src={event.note.data.cover}
                                                           alt={event.note.data.coverImageAlt || event.title}
                                                           class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500"
                                                       />
                                                   </div>
                                               </a>
                                           )}
                                      </div>
                                  );
                             })}
                        </div>
                     ) : (
                        /* No activity message */
                        <div class="ml-9 md:ml-12 p-10 text-center bg-tooling-gray dark:bg-slate-900 border border-dashed border-slate-200 dark:border-slate-700">
                            <p class="text-sm text-secondary tracking-widest">
                                No Data Streams Active
                            </p>
                        </div>
                    )}
                </div>
            );
        })
    }

    {/* No results message */}
    <div id="no-results" class="hidden text-center py-12">
        <p class="metadata text-slate-500">
            NO_MATCHING_DATA_FOUND
        </p>
    </div>

    {/* Show more activity button */}
    <div class="text-center mt-16 ml-9 md:ml-12">
        <button
            id="show-more-activity"
            class="px-10 py-4 bg-terminal-dark dark:bg-white text-white dark:text-terminal-dark font-mono text-sm font-bold tracking-widest transition-all hover:bg-blueprint-blue hover:text-white dark:hover:bg-blueprint-blue shadow-[4px_4px_0_0_#e2e8f0] dark:shadow-none hover:shadow-[6px_6px_0_0_#4382ff] active:shadow-none active:translate-x-1 active:translate-y-1 hidden"
        >
            Load More Streams
        </button>
    </div>
</div>

<style>
    .month-no-activity {
        border: 1.5px dashed #e2e8f0;
    }
</style>
