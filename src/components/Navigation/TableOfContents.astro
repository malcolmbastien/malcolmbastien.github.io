---

import BackToGarden from "./BackToGarden.astro";

// TableOfContents.astro - Automatically generates table of contents from headings
interface Props {
    content: string;
    title: string;
    minHeadings?: number;
}

const { content, title, minHeadings = 3 } = Astro.props;

// Extract headings from Markdown content (skip frontmatter)
const contentWithoutFrontmatter = content.replace(/^---[\s\S]*?---\n/, "");
const headingRegex = /^(#{2,6})\s+(.+)$/gm; // H2-H6 headings
const headings: Array<{ level: number; id: string; text: string }> = [];
let match;

while ((match = headingRegex.exec(contentWithoutFrontmatter)) !== null) {
    const level = match[1].length - 1; // H2 = level 1, H3 = level 2, H4 = level 3, etc.
    const text = match[2].trim();

    // Generate ID from text (similar to how Astro generates heading IDs)
    const id = text
        .toLowerCase()
        .replace(/[^\w\s-]/g, "") // Remove special characters
        .replace(/\s+/g, "-") // Replace spaces with hyphens
        .replace(/-+/g, "-") // Replace multiple hyphens with single
        .replace(/^-|-$/g, ""); // Remove leading/trailing hyphens

    // Include H2-H6 headings
    headings.push({ level, id, text });
}

// Only show TOC if we have enough headings
const showTOC = headings.length >= minHeadings;

// Create nested structure for TOC
const createTOCStructure = (
    title: string,
    headings: Array<{ level: number; id: string; text: string }>,
) => {
    const toc: Array<{ id: string; text: string; children?: any[] }> = [];
    const stack: Array<{ item: any; level: number }> = [];

    // Add the post title as the first item
    const titleItem = {
        id: "",
        text: title,
        children: [],
    };
    toc.push(titleItem);
    stack.push({ item: titleItem, level: 1 });

    headings.forEach((heading) => {
        const item = { id: heading.id, text: heading.text, children: [] };

        // Find the appropriate parent level
        while (
            stack.length > 0 &&
            stack[stack.length - 1].level >= heading.level
        ) {
            stack.pop();
        }

        if (stack.length === 0) {
            toc.push(item);
        } else {
            stack[stack.length - 1].item.children!.push(item);
        }

        stack.push({ item, level: heading.level });
    });

    return toc;
};

const tocStructure = createTOCStructure(title, headings);
---
{
    showTOC && (
        <aside class="w-full">
            <nav class="toc-nav relative">
                    {tocStructure.map((item, index) => {
                        const isPostTitle = index === 0 && item.id === "";

                        return (
                            <div class="toc-item relative mb-4">
                                 <a
                                     href={isPostTitle ? "#" : `#${item.id}`}
                                     id={`toc-${item.id}`}
                                      class={`toc-link block transition-all py-1 pl-6 ${
                                          isPostTitle
                                      ? "text-base font-bold text-slate-800 dark:text-slate-100"
                                              : "metadata text-sm font-bold text-slate-500 dark:text-slate-400 hover:text-slate-600 dark:hover:text-slate-300"
                                      }`}
                                 >
                                    {item.text.toUpperCase()}
                                </a>
                                {item.children &&
                                    item.children.length > 0 && (
                                        <div class="ml-6 mt-2 space-y-2">
                                            {item.children.map((child, childIndex) => (
                                                <div class="relative">
                                                    <a
                                                         href={`#${child.id}`}
                                                         id={`toc-${child.id}`}
                                                         class="toc-link block metadata text-sm text-slate-500 dark:text-slate-400 hover:text-blueprint-blue dark:hover:text-white transition-colors py-0.5 pl-4"
                                                     >
                                                        {child.text.toUpperCase()}
                                                    </a>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                            </div>
                        );
                    })}
                </nav>
            </div>
        </aside>
    )
}

<style>
    @reference "../../styles/global.css";

    .toc-nav {
        max-height: calc(100vh - 200px);
        overflow-y: auto;
    }

    .toc-nav::-webkit-scrollbar {
        width: 4px;
    }

    .toc-nav::-webkit-scrollbar-track {
        background: transparent;
    }

    .toc-nav::-webkit-scrollbar-thumb {
        background: rgb(203 213 225);
        border-radius: 2px;
    }

    .dark .toc-nav::-webkit-scrollbar-thumb {
        background: rgb(71 85 105);
    }

    /* Active TOC link styling */
    .toc-link.active {
        @apply text-blueprint-blue dark:text-blue-300 border-blueprint-blue dark:border-blue-300;
    }



</style>
