---
import { getCollection } from "astro:content";
import Layout from "../../layouts/Layout.astro";
import SiteFooter from "../../components/SiteFooter.astro";

const allNotes = await getCollection("notes");

const topicCounts: Record<string, number> = {};
allNotes.forEach((note) => {
    note.data.tags.forEach((topic: string) => {
        topicCounts[topic] = (topicCounts[topic] || 0) + 1;
    });
});

const sortedTopics = Object.entries(topicCounts).sort((a, b) => a[0].localeCompare(b[0], undefined, { sensitivity: 'base' }));

// Group topics by first character
const groupedTopics = sortedTopics.reduce((acc, [topic, count]) => {
    let firstChar = topic[0].toUpperCase();
    if (!/^[A-Z]$/.test(firstChar)) {
        firstChar = "#";
    }
    if (!acc[firstChar]) {
        acc[firstChar] = [];
    }
    acc[firstChar].push([topic, count]);
    return acc;
}, {} as Record<string, typeof sortedTopics>);

const alphabet = Object.keys(groupedTopics).sort((a, b) => {
    if (a === "#") return -1;
    if (b === "#") return 1;
    return a.localeCompare(b);
});

// Popularity threshold for visual highlighting
const POPULAR_THRESHOLD = 10;
---

<Layout
    title="Topic Index â€” Flow Focused Digital Garden"
    description="A curated map of knowledge, interconnected through tags and themes."
    type="website"
>
    <main class="max-w-7xl mx-auto px-6 py-12" data-pagefind-ignore>
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-12">
            <!-- Left Sidebar: Alphabetical Navigation -->
            <aside class="lg:col-span-1 hidden lg:block">
                <div class="sticky top-24 space-y-8 alphabet-nav overflow-y-auto max-h-[80vh] pr-4 no-scrollbar border-r border-slate-200 dark:border-slate-800">
                    <div class="flex flex-col gap-2">
                        {alphabet.map(char => (
                            <a
                                href={`#${char === "#" ? "num" : char}`}
                                class="text-sm font-semibold text-slate-400 hover:text-primary dark:hover:text-blue-400 transition-colors uppercase"
                            >
                                {char}
                            </a>
                        ))}
                    </div>
                </div>
            </aside>

            <!-- Main Content Area -->
            <div class="lg:col-span-10">
                <header class="mb-12">
                    <h1 class="text-5xl font-bold text-slate-900 dark:text-white mb-4">Topic Index</h1>
                    <p class="text-slate-500 dark:text-slate-400 text-lg italic">A curated map of knowledge, interconnected through tags and themes.</p>
                </header>

                <div class="space-y-16">
                    {alphabet.map((letter) => (
                        <section class="scroll-mt-24" id={letter === "#" ? "num" : letter}>
                            <h2 class="text-4xl font-black text-slate-900 dark:text-blue-400 mb-8 border-b border-slate-200 dark:border-slate-800 pb-2 uppercase">
                                {letter}
                            </h2>
                            <div class="space-y-3">
                                {groupedTopics[letter].map(([topic, count]) => {
                                    const isPopular = count >= POPULAR_THRESHOLD;
                                    return (
                                        <a
                                            href={`/topics/${topic}`}
                                            class="group flex items-center justify-between py-3 border-b border-slate-100 dark:border-slate-800 hover:bg-slate-50/50 dark:hover:bg-slate-800/30 transition-colors"
                                        >
                                            <span class:list={[
                                                "text-base font-medium transition-colors",
                                                isPopular
                                                    ? "text-primary dark:text-blue-400 group-hover:text-blue-700 dark:group-hover:text-blue-300"
                                                    : "text-slate-600 dark:text-slate-300 group-hover:text-slate-900 dark:group-hover:text-white"
                                            ]}>#{topic}</span>
                                            <span class="text-xs font-mono text-slate-400">{count}</span>
                                        </a>
                                    );
                                })}
                            </div>
                        </section>
                    ))}

                    <p class="text-center py-12 text-slate-400 text-sm italic">
                        End of index. Stay curious.
                    </p>
                </div>
            </div>


        </div>
    </main>
    <SiteFooter />
</Layout>

<style>
    @reference "../../styles/global.css";

    .alphabet-nav::-webkit-scrollbar {
        display: none;
    }
</style>

<script>
    // Client-side filtering logic
    const filterInput = document.getElementById('topic-filter') as HTMLInputElement;
    const topicSections = document.querySelectorAll('section.scroll-mt-24');

    if (filterInput) {
        filterInput.addEventListener('input', (e) => {
            const term = (e.target as HTMLInputElement).value.toLowerCase();

            topicSections.forEach(section => {
                let hasVisibleTopics = false;
                const topics = section.querySelectorAll('a.group');

                topics.forEach(topic => {
                    const text = topic.textContent?.toLowerCase() || '';
                    if (text.includes(term)) {
                        (topic as HTMLElement).style.display = 'flex';
                        hasVisibleTopics = true;
                    } else {
                        (topic as HTMLElement).style.display = 'none';
                    }
                });

                // Hide the whole section (including letter header) if no topics match
                (section as HTMLElement).style.display = hasVisibleTopics ? 'block' : 'none';
            });
        });
    }
</script>
