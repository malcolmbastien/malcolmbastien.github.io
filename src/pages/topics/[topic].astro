---
import { getCollection } from "astro:content";
import Layout from "../../layouts/Layout.astro";
import BackToGarden from "../../components/Navigation/BackToGarden.astro";
import SiteFooter from "../../components/SiteFooter.astro";

export async function getStaticPaths() {
    const allNotes = await getCollection("notes");
    const topics = new Set<string>();
    allNotes.forEach((note) => {
        note.data.tags.forEach((tag) => topics.add(tag));
    });
    return Array.from(topics).map((topic) => ({
        params: { topic },
    }));
}

const { topic } = Astro.params;

const allNotes = await getCollection("notes");
const filteredNotes = allNotes.filter((note) => note.data.tags.includes(topic!));

const sortedNotes = filteredNotes.sort(
    (a, b) =>
        (b.data.publishedDate?.getTime() || 0) -
        (a.data.publishedDate?.getTime() || 0),
);
---

<Layout
    title={`#${topic} - Notes - Sprout`}
    description={`All notes about #${topic}`}
    type="website"
>
    <main class="max-w-(--breakpoint-2xl) mx-auto p-4 md:p-8" data-pagefind-ignore>
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-10">
            <div class="lg:col-span-3">
                <div class="lg:sticky lg:top-24">
                    <BackToGarden />
                </div>
            </div>

            <div class="lg:col-span-9 max-w-4xl">
                <header class="mb-16 border-b border-slate-100 dark:border-slate-800 pb-10">
                    <div class="flex items-center gap-4 mb-8">
                        <h1 class="text-6xl font-serif font-black text-primary tracking-tighter leading-none">
                            Topic: {topic}
                        </h1>
                    </div>
                    <p class="text-sm font-bold text-secondary tracking-widest">
                        Notes: {sortedNotes.length.toString().padStart(3, '0')}
                    </p>
                </header>

                {
                    sortedNotes.length === 0 ? (
                        <div class="surface-elevation p-12 text-center bg-tooling-gray dark:bg-slate-900 border-none">
                            <p class="text-sm text-secondary italic tracking-widest">
                                Zero Notes Indexed for Topic
                            </p>
                        </div>
                    ) : (
                        <div class="space-y-8">
                            {sortedNotes.map((note) => (
                                <a
                                    href={`/notes/${note.id.replace('.md', '')}`}
                                    class="card-interactive group block p-10"
                                >
                                    <div class="flex justify-between items-center mb-6">
                                        <span class={`text-sm font-bold text-signal-${note.data.stage}`}>
                                            {note.data.stage.charAt(0).toUpperCase() + note.data.stage.slice(1)}
                                        </span>
                                        {note.data.publishedDate && (
                                            <time class="text-xs text-secondary font-mono">
                                                {note.data.publishedDate.toLocaleDateString("en-US", { month: 'short', year: 'numeric' })}
                                            </time>
                                        )}
                                    </div>
                                    <h2 class="text-3xl font-bold text-primary mb-4 leading-tight group-hover:text-blueprint-blue transition-colors">
                                        {note.data.title}
                                    </h2>
                                    {note.data.summary && (
                                        <p class="text-secondary line-clamp-2 leading-relaxed max-w-2xl">
                                            {note.data.summary}
                                        </p>
                                    )}
                                </a>
                            ))}
                        </div>
                    )
                }
            </div>
        </div>
        <SiteFooter />
    </main>
</Layout>
