---
import { getCollection } from "astro:content";
import Layout from "../../layouts/Layout.astro";
import ProfileHeader from "../../components/Profile/ProfileHeader.astro";
import SiteFooter from "../../components/SiteFooter.astro";

export async function getStaticPaths() {
    const allPosts = await getCollection("posts");
    const topics = new Set<string>();
    allPosts.forEach((post) => {
        post.data.tags.forEach((tag) => topics.add(tag));
    });
    return Array.from(topics).map((topic) => ({
        params: { topic },
    }));
}

const { topic } = Astro.params;

const allPosts = await getCollection("posts");
const filteredPosts = allPosts.filter((post) => post.data.tags.includes(topic));

const sortedPosts = filteredPosts.sort(
    (a, b) =>
        (b.data.publishedDate?.getTime() || 0) -
        (a.data.publishedDate?.getTime() || 0),
);
---

<Layout
    title={`#${topic} - Posts - Sprout`}
    description={`All posts about #${topic}`}
    type="website"
>
    <main class="max-w-7xl mx-auto p-4 md:p-8" data-pagefind-ignore>
        <ProfileHeader />
        <!-- Back to Home Link -->
        <div>
            <nav class="-mt-2 mb-8">
                <a
                    href="/"
                    class="inline-flex items-center gap-2 text-sm font-medium text-slate-500 dark:text-slate-400 hover:text-emerald-600 dark:hover:text-emerald-400 transition-colors"
                >
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        class="h-4 w-4"
                        viewBox="0 0 20 20"
                        fill="currentColor"
                    >
                        <path
                            fill-rule="evenodd"
                            d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z"
                            clip-rule="evenodd"></path>
                    </svg>
                    Back to Garden
                </a>
            </nav>
        </div>

        <div class="mb-6">
            <h1
                class="text-3xl font-extrabold text-slate-900 dark:text-white tracking-tight mb-2"
            >
                #{topic}
            </h1>
            <p class="text-slate-600 dark:text-slate-400">
                {sortedPosts.length} post{sortedPosts.length !== 1 ? "s" : ""} found
            </p>
        </div>

        {
            sortedPosts.length === 0 ? (
                <div class="bg-white dark:bg-[#121812] border border-slate-200 dark:border-slate-800 rounded-xl p-8 text-center">
                    <p class="text-slate-600 dark:text-slate-400">
                        No posts found for this topic.
                    </p>
                </div>
            ) : (
                <div class="space-y-4">
                    {sortedPosts.map((post) => (
                        <a
                            href={`/posts/${post.slug}`}
                            class="block bg-white dark:bg-[#121812] border border-slate-200 dark:border-slate-800 rounded-xl p-5 hover:border-emerald-500 dark:hover:border-emerald-500 transition-colors group"
                        >
                            <div class="flex items-center gap-2 mb-2">
                                <span
                                    class={`px-2 py-0.5 rounded text-xs font-medium ${
                                        post.data.status === "seed"
                                            ? "bg-emerald-100 text-emerald-800 dark:bg-emerald-900/30 dark:text-emerald-400"
                                            : post.data.status === "sprout"
                                              ? "bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-400"
                                              : "bg-purple-100 text-purple-800 dark:bg-purple-900/30 dark:text-purple-400"
                                    }`}
                                >
                                    {post.data.status}
                                </span>
                                {post.data.publishedDate && (
                                    <time class="text-sm text-slate-500 dark:text-slate-400">
                                        {post.data.publishedDate.toLocaleDateString(
                                            "en-US",
                                            {
                                                year: "numeric",
                                                month: "short",
                                                day: "numeric",
                                            },
                                        )}
                                    </time>
                                )}
                            </div>
                            <h2 class="text-xl font-bold text-slate-900 dark:text-slate-100 mb-2 group-hover:text-emerald-600 dark:group-hover:text-emerald-400 transition-colors">
                                {post.data.title}
                            </h2>
                            {post.data.summary && (
                                <p class="text-sm text-slate-600 dark:text-slate-400 line-clamp-2">
                                    {post.data.summary}
                                </p>
                            )}
                        </a>
                    ))}
                </div>
            )
        }
        <SiteFooter />
    </main>
</Layout>
