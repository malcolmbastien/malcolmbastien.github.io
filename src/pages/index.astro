---
import { getCollection, type CollectionEntry } from 'astro:content';
import Layout from '../layouts/Layout.astro';
import ActivityHeatmap from '../components/Profile/ActivityHeatmap.astro';
import ProfileHeader from '../components/Profile/ProfileHeader.astro';
import { getFileDates } from '../lib/git-history';

const allPosts = await getCollection('posts');

// Fetch git dates for all posts to allow sorting by creation date
const postsWithDates = await Promise.all(
	allPosts.map(async (post) => {
		const filePath = `src/content/posts/${post.id}`;
		const { created } = await getFileDates(filePath);
		return {
			...post,
			displayDate: post.data.publishedDate || created || new Date(),
		};
	})
);

const sortedPosts = postsWithDates.sort((a, b) => b.displayDate.valueOf() - a.displayDate.valueOf());

const statusColors: Record<'seed' | 'sprout' | 'tree', string> = {
	seed: 'bg-slate-100 text-slate-600 border-slate-200',
	sprout: 'bg-green-100 text-green-700 border-green-200',
	tree: 'bg-emerald-100 text-emerald-800 border-emerald-200',
};
---

<Layout title="Taskmaster">
	<main class="max-w-4xl mx-auto p-8">
		<ProfileHeader />

		<ActivityHeatmap />

		<div class="mb-8 flex gap-4" id="filter-buttons">
			<button class="px-4 py-2 rounded-md bg-slate-900 text-white text-sm font-medium hover:bg-slate-800 transition-colors active-filter" data-status="all">All</button>
			<button class="px-4 py-2 rounded-md bg-white border border-slate-200 text-slate-600 text-sm font-medium hover:bg-slate-50 transition-colors" data-status="seed">ðŸŒ± Seeds</button>
			<button class="px-4 py-2 rounded-md bg-white border border-slate-200 text-slate-600 text-sm font-medium hover:bg-slate-50 transition-colors" data-status="sprout">ðŸŒ¿ Sprouts</button>
			<button class="px-4 py-2 rounded-md bg-white border border-slate-200 text-slate-600 text-sm font-medium hover:bg-slate-50 transition-colors" data-status="tree">ðŸŒ³ Trees</button>
		</div>

		<div class="grid gap-6" id="posts-grid">
			{sortedPosts.map((post) => (
				<a href={`/posts/${post.slug}`} class="block p-6 rounded-xl border border-slate-200 bg-white hover:border-emerald-300 hover:shadow-sm transition-all post-card" data-status={post.data.status}>
					<div class="flex items-center gap-3 mb-3">
						<span class={`px-2 py-0.5 rounded-full text-[10px] font-semibold border uppercase tracking-wider flex items-center gap-1 ${statusColors[post.data.status as keyof typeof statusColors]}`}>
							{post.data.status === 'seed' && <span>ðŸŒ±</span>}
							{post.data.status === 'sprout' && <span>ðŸŒ¿</span>}
							{post.data.status === 'tree' && <span>ðŸŒ³</span>}
							{post.data.status}
						</span>
						<time class="text-xs text-slate-400">
							{post.displayDate.toLocaleDateString('en-US', {
								year: 'numeric',
								month: 'short',
								day: 'numeric',
							})}
						</time>
					</div>
					<h2 class="text-xl font-bold text-slate-900 mb-2">{post.data.title}</h2>
					<p class="text-slate-600 text-sm line-clamp-2">{post.data.summary}</p>
					<div class="mt-4 flex flex-wrap gap-2">
						{post.data.tags.map((tag: string) => (
							<span class="bg-slate-50 text-slate-500 px-2 py-0.5 rounded text-[10px] border border-slate-100">
								#{tag}
							</span>
						))}
					</div>
				</a>
			))}
		</div>
	</main>
</Layout>

<script>
	const buttons = document.querySelectorAll('#filter-buttons button');
	const cards = document.querySelectorAll('.post-card');

	buttons.forEach(button => {
		button.addEventListener('click', () => {
			const status = (button as HTMLElement).dataset.status;
			
			// Update button styles
			buttons.forEach(btn => {
				btn.classList.remove('bg-slate-900', 'text-white');
				btn.classList.add('bg-white', 'border', 'border-slate-200', 'text-slate-600');
			});
			button.classList.remove('bg-white', 'border', 'border-slate-200', 'text-slate-600');
			button.classList.add('bg-slate-900', 'text-white');

			// Filter cards
			cards.forEach(card => {
				const cardStatus = (card as HTMLElement).dataset.status;
				if (status === 'all' || cardStatus === status) {
					(card as HTMLElement).style.display = 'block';
				} else {
					(card as HTMLElement).style.display = 'none';
				}
			});
		});
	});
</script>
