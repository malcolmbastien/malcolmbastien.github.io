---
import { getCollection } from "astro:content";
import { statSync } from "node:fs";
import Layout from "../layouts/Layout.astro";
import HeroBanner from "../components/HeroBanner.astro";
import YearNavigation from "../components/YearNavigation.astro";
import NoteTimeline from "../components/NoteTimeline.astro";
import SiteFooter from "../components/SiteFooter.astro";
import GardenStats from "../components/Profile/GardenStats.astro";
import TopicFocus from "../components/Profile/TopicFocus.astro";

import { getStageData } from "../lib/theme";

const allNotes = await getCollection("notes");

// Use publishedDate from frontmatter, or fall back to file creation date
const notesWithDates = allNotes
    .filter((note) => !note.data.draft)
    .map((note) => {
        let displayDate: Date;
        if (note.data.publishedDate) {
            displayDate = note.data.publishedDate;
        } else {
            // Fall back to file birthtime (creation date)
            const stats = statSync(note.filePath || `src/content/notes/${note.id}`);
            displayDate = stats.birthtime;
        }
        return {
            ...note,
            displayDate,
        };
    });

// Create timeline events
const events: any[] = [];
notesWithDates.forEach((note) => {
    const displayDate = note.displayDate as Date;

    events.push({
        type: "created",
        note,
        date: displayDate,
        title: note.data.title,
    });
});

// Aggregate events
const aggregatedEvents: any[] = [];
const eventGroups = new Map();

events.forEach((event) => {
    const dateStr = (event.date as Date).toISOString().split("T")[0];
    const key = `${event.note.slug}-${event.type}-${dateStr}`;
    if (!eventGroups.has(key)) {
        eventGroups.set(key, []);
    }
    eventGroups.get(key).push(event);
});

eventGroups.forEach((group) => {
    if (group.length === 1) {
        aggregatedEvents.push(group[0]);
    } else {
        const firstEvent = group[0];
        const lastEvent = group[group.length - 1];
        aggregatedEvents.push({
            ...firstEvent,
            count: group.length,
            date: lastEvent.date,
        });
    }
});

const sortedEvents = aggregatedEvents.sort(
    (a, b) => b.date.valueOf() - a.date.valueOf(),
);

// Generate all months
const earliestDate =
    sortedEvents.length > 0
        ? sortedEvents[sortedEvents.length - 1]?.date || new Date()
        : new Date();

const allMonths: Array<{
    key: string;
    date: Date;
    hasActivity: boolean;
}> = [];

const currentDate = new Date();
currentDate.setDate(1);
currentDate.setHours(0, 0, 0, 0);

const endDate = new Date(earliestDate);
endDate.setDate(1);
endDate.setHours(0, 0, 0, 0);

const eventsByMonthKey = new Map<string, any[]>();
sortedEvents.forEach((event) => {
    const monthKey = event.date.toLocaleDateString("en-US", {
        year: "numeric",
        month: "long",
    });
    if (!eventsByMonthKey.has(monthKey)) {
        eventsByMonthKey.set(monthKey, []);
    }
    eventsByMonthKey.get(monthKey)?.push(event);
});

while (currentDate >= endDate) {
    const monthKey = currentDate.toLocaleDateString("en-US", {
        year: "numeric",
        month: "long",
    });
    allMonths.push({
        key: monthKey,
        date: new Date(currentDate),
        hasActivity: eventsByMonthKey.has(monthKey),
    });
    currentDate.setMonth(currentDate.getMonth() - 1);
}

// Collect years data
const yearsData = new Map();
sortedEvents.forEach((event) => {
    const year = event.date.getFullYear();
    const month = event.date.getMonth();

    if (!yearsData.has(year)) {
        yearsData.set(year, { count: 0, months: new Set(), uniqueNotes: new Set() });
    }
    yearsData.get(year).count++;
    yearsData.get(year).months.add(month);
    yearsData.get(year).uniqueNotes.add(event.note.id);
});

const yearsArray = Array.from(yearsData.entries());
yearsArray.sort((a, b) => b[0] - a[0]);
const sortedYears = yearsArray.map(([year, data]) => ({
    year: year as number,
    count: data.uniqueNotes.size,
    activityCount: data.count as number,
    months: (Array.from(data.months) as number[]).sort((a, b) => b - a),
}));

// Identify pinned notes
const pinnedNotes = allNotes.filter((note) => (note.data as any).pinned === true);

// Get latest 3 created notes
const latestCreations = notesWithDates
    .filter(p => !!p.displayDate && !pinnedNotes.some(pinned => pinned.id === p.id))
    .sort((a, b) => b.displayDate!.valueOf() - a.displayDate!.valueOf())
    .slice(0, 3);

// Compute note counts
const publishedNotes = allNotes.filter((note) => note.data);
const counts = {
    all: publishedNotes.length,
    seed: publishedNotes.filter((n: any) => n.data.stage === "seed").length,
    sprout: publishedNotes.filter((n: any) => n.data.stage === "sprout").length,
    evergreen: publishedNotes.filter((n: any) => n.data.stage === "evergreen").length,
};

const currentYearValue = new Date().getFullYear();

// Helper for stage styling
const getStageBadgeClass = (stage: string) => {
    const stageData = getStageData(stage);
    return stageData.colors.badge;
};

const getStageKeylineClass = (stage: string) => {
    switch (stage) {
        case 'seed':
            return 'border-l-orange-600';
        case 'sprout':
            return 'border-l-yellow-600';
        case 'evergreen':
            return 'border-l-green-600';
        default:
            return 'border-l-slate-400';
    }
};

const getStageBackgroundClass = (stage: string) => {
    const stageData = getStageData(stage);
    return stageData.colors.bgAccent;
};

const getStageCardClass = (stage: string) => {
    // All pinned notes use the same subtle styling regardless of stage
    return 'bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700';
};
---

<Layout
    title="Malcolm Bastien - Flow Focused"
    description="A digital garden of thoughts and ideas. Explore seeds, sprouts, and evergreens of knowledge in this ever-growing collection of writings."
    type="website"
>
    <style slot="head" is:inline set:html={
        sortedYears.map(y => `
        html[data-selected-year="${y.year}"] .timeline-event:not([data-event-year="${y.year}"]),
        html[data-selected-year="${y.year}"] .month-section:not([data-year="${y.year}"]) {
            display: none !important;
        }

        html:not(.js-initialized)[data-selected-year="${y.year}"] .timeline-event[data-event-year="${y.year}"][data-is-initial-batch="false"] {
            display: none !important;
        }

        html[data-selected-year="${y.year}"] .year-btn[data-year="${y.year}"] {
            color: rgb(37, 99, 235) !important;
            font-weight: 700;
        }
        html.dark[data-selected-year="${y.year}"] .year-btn[data-year="${y.year}"] {
            color: rgb(37, 99, 235) !important;
        }
        html[data-selected-year="${y.year}"] .year-item:has(.year-btn[data-year="${y.year}"]) .month-submenu {
            display: flex !important;
        }
        `).join('')
    } />
    <script slot="head" is:inline>
        (function() {
            const savedYear = localStorage.getItem('selectedYear');
            const currentYear = new Date().getFullYear().toString();
            document.documentElement.setAttribute('data-selected-year', savedYear || currentYear);
        })();
    </script>

    <main class="max-w-7xl mx-auto px-6 py-12" data-pagefind-ignore>
        <HeroBanner />

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-12">
            <!-- Year Navigation -->
            <aside class="hidden lg:block lg:col-span-1 border-r border-slate-100 dark:border-slate-800 pr-4">
                <nav class="sticky top-24 space-y-6">
                    <div>
                        <YearNavigation sortedYears={sortedYears as any} />
                    </div>
                </nav>
            </aside>

            <!-- Main Content -->
            <div class="lg:col-span-8">


                {/* Pinned Notes Section */}
                {
                    pinnedNotes.length > 0 && (
                        <section class="mb-8">
                            <div class="flex items-center justify-between mb-8">
                                <div class="text-xs font-bold text-stone-400 uppercase tracking-widest">Pinned Notes</div>
                                <div class="h-px bg-stone-100 dark:bg-slate-800 grow ml-6"></div>
                            </div>
                            <div>
                                {pinnedNotes.map((note, index) => (
                                    <a href={`/notes/${note.id.replace('.md', '')}`} class={`group block relative my-4 py-5 px-5 border-l-[6px] ${getStageKeylineClass(note.data.stage)} bg-stone-50/50 dark:bg-slate-800/30 hover:bg-stone-100 dark:hover:bg-slate-800 transition-colors cursor-pointer rounded-r`}>
                                        <div class="flex items-center justify-between mb-3">
                                            <div class="flex items-center gap-3">
                                                <span class="text-[10px] font-bold tracking-widest text-stone-400 dark:text-stone-500 uppercase">
                                                    Pinned
                                                </span>
                                            </div>
                                            <span class="material-symbols-outlined text-stone-400 dark:text-stone-600 text-base">push_pin</span>
                                        </div>
                                        <h3 class="text-2xl font-bold text-stone-900 dark:text-white mb-3 group-hover:text-primary dark:group-hover:text-blue-400 transition-colors">
                                            {note.data.title}
                                        </h3>
                                        {note.data.summary && (
                                            <p class="text-stone-600 dark:text-stone-400 text-base leading-relaxed mb-4">
                                                {note.data.summary}
                                            </p>
                                        )}
                                    </a>
                                ))}
                            </div>
                        </section>
                    )
                }

                {/* Current Stream */}
                <section>
                    <div class="flex items-center justify-between mb-8">
                        <div class="text-xs font-bold text-stone-400 uppercase tracking-widest">Recent Notes</div>
                        <div class="h-px bg-stone-100 dark:bg-slate-800 grow ml-6"></div>
                    </div>

                    <NoteTimeline
                        sortedEvents={sortedEvents}
                        allMonths={allMonths}
                        eventsByMonthKey={eventsByMonthKey}
                        initialYear={currentYearValue.toString()}
                    />

                    {/* Load More Button */}
                    <div class="mt-12 text-center">
                        <button
                            id="show-more-activity"
                            class="px-8 py-3 bg-slate-900 dark:bg-white text-white dark:text-slate-900 text-sm font-bold rounded-full hover:scale-105 transition-transform shadow-lg hidden"
                        >
                            Load More Insights
                        </button>
                    </div>
                </section>
            </div>

            <!-- Sidebar -->
            <aside class="lg:col-span-3 space-y-12">
                {/* Taxonomy Guide */}
                <GardenStats counts={counts} />

                {/* Key Focus Areas */}
                <TopicFocus />

                {/* Latest Creations */}
                <div>
                    <h4 class="text-base font-semibold text-stone-700 mb-6">Latest Notes</h4>
                    <div class="space-y-2">
                        {latestCreations.map((note) => (
                            <div class="group">
                                <span class="text-xs font-medium text-stone-400 block mb-1">
                                    {note.displayDate!.toLocaleDateString("en-US", {
                                        month: 'short',
                                        day: 'numeric',
                                        year: 'numeric',
                                        timeZone: 'UTC'
                                    })}
                                </span>
                                <a href={`/notes/${note.id.replace('.md', '')}`} class="text-sm font-semibold text-stone-900 dark:text-white hover:underline decoration-primary/50 underline-offset-2 transition-colors">
                                    {note.data.title}
                                </a>
                            </div>
                        ))}
                    </div>
                </div>
            </aside>
        </div>
    </main>
    <SiteFooter />
</Layout>

<style is:global>
    @reference "../styles/global.css";

    .timeline-event.hidden-by-filter {
        display: none !important;
    }
</style>

<script>
    declare global {
        interface Window {
            updateHeatmapYear?: (year: number) => void;
        }
    }

    const noResults = document.getElementById("no-results");

    if ('scrollRestoration' in history) {
        history.scrollRestoration = 'manual';
    }

    let currentFilter = "all";
    let currentTopic = "";
    let currentYear = document.documentElement.getAttribute('data-selected-year') || new Date().getFullYear().toString();
    let currentDateFilter: string | null = null;
    let itemsToShow = 10;

    const showMoreButton = document.getElementById("show-more-activity");

    function updateDisplay() {
        let totalMatchingCount = 0;
        let visibleCount = 0;

        const allTimelineEvents = document.querySelectorAll("#timeline .timeline-event");

        allTimelineEvents.forEach((event) => {
            const htmlEvent = event as HTMLElement;
            const stage = htmlEvent.dataset.stage;
            const eventYear = htmlEvent.dataset.eventYear || "";

            const matchesFilter = currentFilter === "all" || stage === currentFilter;
            const matchesTopic = currentTopic === "" || (htmlEvent.dataset.topics || "").includes(currentTopic);
            const matchesYear = currentYear === "all" || eventYear === currentYear;
            const eventDate = htmlEvent.dataset.created || "";
            const matchesDate = currentDateFilter === null || eventDate === currentDateFilter;

            if (matchesFilter && matchesTopic && matchesYear && matchesDate) {
                totalMatchingCount++;
                if (visibleCount < itemsToShow) {
                    htmlEvent.classList.remove("hidden-by-filter");
                    visibleCount++;
                } else {
                    htmlEvent.classList.add("hidden-by-filter");
                }
            } else {
                htmlEvent.classList.add("hidden-by-filter");
            }
        });

        document.querySelectorAll(".month-section").forEach((section) => {
            const htmlSection = section as HTMLElement;
            const eventsInSection = Array.from(
                htmlSection.querySelectorAll(".timeline-event"),
            );
            const hasVisibleEvent = eventsInSection.some(
                (e) => !(e as HTMLElement).classList.contains("hidden-by-filter")
            );

            htmlSection.style.display = hasVisibleEvent ? "block" : "none";
        });

        if (showMoreButton) {
            if (totalMatchingCount > itemsToShow) {
                showMoreButton.classList.remove("hidden");
                showMoreButton.textContent = `Load More Insights (${totalMatchingCount - itemsToShow} remaining)`;
            } else {
                showMoreButton.classList.add("hidden");
            }
        }

        if (noResults) {
            if (totalMatchingCount === 0) noResults.classList.remove("hidden");
            else noResults.classList.add("hidden");
        }
    }

    if (showMoreButton) {
        showMoreButton.addEventListener("click", () => {
            itemsToShow += 10;
            updateDisplay();
        });
    }

    const yearButtons = document.querySelectorAll(".year-btn");
    const monthButtons = document.querySelectorAll(".month-btn");

    function selectYear(year: string, button: HTMLElement, isManualClick: boolean = false) {
        const yearItem = button.closest(".year-item") as HTMLElement;
        const monthSubmenu = yearItem?.querySelector(".month-submenu") as HTMLElement;

        itemsToShow = 10;
        document.documentElement.setAttribute('data-selected-year', year);

        if (currentYear === year) {
            if (monthSubmenu && isManualClick) {
                monthSubmenu.classList.toggle("hidden");
            }
        } else {
            yearButtons.forEach((btn) => {
                const item = btn.closest(".year-item");
                const submenu = item?.querySelector(".month-submenu");
                if (submenu) submenu.classList.add("hidden");
            });

            currentYear = year;

            // Update the heatmap year label
            const heatmapLabel = document.getElementById('heatmap-year-label');
            if (heatmapLabel) {
                heatmapLabel.textContent = `Activity in ${year}`;
            }

            if (window.updateHeatmapYear) {
                window.updateHeatmapYear(parseInt(year));
            }
        }
        updateDisplay();
    }

    yearButtons.forEach((button) => {
        button.addEventListener("click", (event) => {
            const year = (button as HTMLElement).dataset.year || "all";
            localStorage.setItem('selectedYear', year);
            selectYear(year, button as HTMLElement, event.isTrusted);
        });
    });

    monthButtons.forEach((button) => {
        button.addEventListener("click", () => {
            const monthKey = (button as HTMLElement).dataset.month || "";
            const year = (button as HTMLElement).dataset.year || "all";

            itemsToShow = 500;

            if (currentYear !== year) {
                localStorage.setItem('selectedYear', year);
                const yearBtn = document.querySelector(
                    `.year-btn[data-year="${year}"]`,
                ) as HTMLElement;
                if (yearBtn) selectYear(year, yearBtn, false);
            }

            updateDisplay();

            setTimeout(() => {
                const monthSection = document.querySelector(
                    `.month-section[data-month="${monthKey}"]`,
                );
                if (monthSection) {
                    monthSection.scrollIntoView({
                        behavior: "smooth",
                        block: "start",
                    });
                }
            }, 10);
        });
    });

    window.addEventListener("dateFilterChange", (e: any) => {
        currentDateFilter = e.detail.date;
        itemsToShow = 10;
        updateDisplay();
    });

    window.addEventListener("updateDisplayNeeded", () => {
        updateDisplay();
    });

    const initYearSelection = () => {
        const savedYear = localStorage.getItem('selectedYear');
        const currentYearStr = new Date().getFullYear().toString();
        const yearToSelect = savedYear || currentYearStr;

        let yearBtn = document.querySelector(
            `.year-btn[data-year="${yearToSelect}"]`,
        ) as HTMLElement;

        if (!yearBtn && savedYear) {
            yearBtn = document.querySelector(
                `.year-btn[data-year="${currentYearStr}"]`,
            ) as HTMLElement;
        }

        if (yearBtn) {
            selectYear(yearBtn.dataset.year || currentYearStr, yearBtn, false);
        } else {
            const allYearBtns = document.querySelectorAll(".year-btn");
            if (allYearBtns.length > 0) {
                const firstBtn = allYearBtns[0] as HTMLElement;
                selectYear(firstBtn.dataset.year || currentYearStr, firstBtn, false);
            }
        }

        document.documentElement.classList.add('js-initialized');
    };

    initYearSelection();
</script>
