---
import "../styles/global.css";
import ThemeToggle from "../components/ThemeToggle.astro";

interface Props {
    title: string;
    description?: string;
    image?: string;
    url?: string;
    type?: "website" | "article";
    publishedTime?: string;
    modifiedTime?: string;
    tags?: string[];
    author?: string;
}

const {
    title,
    description = "A digital garden of thoughts and ideas",
    image = "/og-default.png",
    url = Astro.site?.origin || new URL(Astro.request.url).origin,
    type = "website",
    publishedTime,
    modifiedTime,
    tags = [],
    author = "Malcolm Bastien",
} = Astro.props;

// Generate canonical URL
const canonicalUrl = new URL(Astro.url.pathname, Astro.site || url).href;

// Generate Open Graph image URL
const ogImage = image.startsWith("http") ? image : url + image;


const currentPath = Astro.url.pathname;

const navItems = [
    { href: "/", label: "Garden" },
    { href: "/topics", label: "Topics" },
    { href: "/search", label: "Search" },
    { href: "/colophon", label: "Colophon" },
    { href: "/about", label: "About" },
];
---

<html lang="en">
    <head>
        <meta charset="utf-8" />
        <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
        <meta name="viewport" content="width=device-width" />
        <meta name="generator" content={Astro.generator} />
        <meta name="fediverse:creator" content="@malcolm@mastodon.social" />

        <!-- Flow Focused Fonts v1.2 -->
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Source+Serif+4:ital,opsz,wght@0,8..60,400;0,8..60,500;0,8..60,600;0,8..60,700;1,8..60,400&family=JetBrains+Mono:wght@400;500&display=swap"
            rel="stylesheet"
        />
        <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet" />

        <!-- Primary Meta Tags -->
        <title>{title}</title>
        <meta name="title" content={title} />
        <meta name="description" content={description} />
        <meta name="author" content={author} />
        <link rel="canonical" href={canonicalUrl} />

        <!-- Open Graph / Facebook -->
        <meta property="og:type" content={type} />
        <meta property="og:url" content={canonicalUrl} />
        <meta property="og:title" content={title} />
        <meta property="og:description" content={description} />
        <meta property="og:image" content={ogImage} />
        <meta property="og:site_name" content="Sprout" />

        <!-- Twitter -->
        <meta property="twitter:card" content="summary_large_image" />
        <meta property="twitter:url" content={canonicalUrl} />
        <meta property="twitter:title" content={title} />
        <meta property="twitter:description" content={description} />
        <meta property="twitter:image" content={ogImage} />

        <!-- Additional SEO -->
        <meta name="robots" content="index, follow" />
        <meta name="language" content="English" />
        {tags.map((tag) => <meta property="article:tag" content={tag} />)}

        <!-- Article specific (only for article type) -->
        {
            type === "article" && publishedTime && (
                <meta
                    property="article:published_time"
                    content={publishedTime}
                />
            )
        }
        {
            type === "article" && modifiedTime && (
                <meta property="article:modified_time" content={modifiedTime} />
            )
        }
        {
            type === "article" && (
                <meta property="article:author" content={author} />
            )
        }

        <!-- Structured Data -->
        <script
            is:inline
            type="application/ld+json"
            set:html={JSON.stringify({
                "@context": "https://schema.org",
                "@type": type === "article" ? "BlogPosting" : "WebSite",
                name: title,
                description: description,
                url: canonicalUrl,
                image: ogImage,
                author: {
                    "@type": "Person",
                    name: author,
                },
                publisher: {
                    "@type": "Organization",
                    name: "Sprout",
                    url: url,
                },
                ...(type === "article" &&
                    publishedTime && { datePublished: publishedTime }),
                ...(type === "article" &&
                    modifiedTime && { dateModified: modifiedTime }),
                ...(type === "article" &&
                    tags.length > 0 && { keywords: tags.join(", ") }),
            })}
        />

        <slot name="head" />

        <script is:inline>
            const theme = (() => {
                if (
                    typeof localStorage !== "undefined" &&
                    localStorage.getItem("theme")
                ) {
                    return localStorage.getItem("theme");
                }
                if (window.matchMedia("(prefers-color-scheme: dark)").matches) {
                    return "dark";
                }
                return "light";
            })();

            if (theme === "light") {
                document.documentElement.classList.remove("dark");
            } else {
                document.documentElement.classList.add("dark");
            }
            window.localStorage.setItem("theme", theme);
        </script>
    </head>
    <body class="min-h-screen bg-background-light dark:bg-background-dark text-slate-900 dark:text-slate-100 transition-colors duration-300 flex flex-col">
        <header class="sticky top-0 z-50 bg-white/80 dark:bg-slate-900/80 backdrop-blur-md border-b border-slate-200 dark:border-slate-800">
            <div class="max-w-7xl mx-auto px-6 h-16 flex items-center justify-between">
                <a href="/" class="flex items-center gap-2">
                    <span class="font-bold text-lg tracking-tight text-blueprint-blue dark:text-blue-400">MALCOLM BASTIEN</span>
                    <span class="text-slate-400 dark:text-slate-500">|</span>
                    <span class="text-black dark:text-white font-bold uppercase tracking-widest text-xs sm:text-sm">FLOW FOCUSED</span>
                    <span class="material-symbols-outlined text-sky-500 ml-1">waves</span>
                </a>
                <nav class="hidden md:flex items-center gap-8 text-sm font-medium">
                    {navItems.map((item) => (
                        <a
                            href={item.href}
                            class:list={[
                                "transition-colors",
                                currentPath.replace(/\/$/, '') === item.href.replace(/\/$/, '')
                                    ? "text-black dark:text-white border-b-2 border-black dark:border-white pb-1"
                                    : "text-slate-500 dark:text-slate-400 hover:text-black dark:hover:text-white"
                            ]}
                        >
                            {item.label}
                        </a>
                    ))}
                    <ThemeToggle />
                </nav>
            </div>
        </header>
        <slot />
    </body>
</html>
