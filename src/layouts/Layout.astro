---
import "../styles/global.css";
import ThemeToggle from "../components/ThemeToggle.astro";

interface Props {
    title: string;
    description?: string;
    image?: string;
    url?: string;
    type?: "website" | "article";
    publishedTime?: string;
    modifiedTime?: string;
    tags?: string[];
    author?: string;
}

const {
    title,
    description = "A digital garden of thoughts and ideas",
    image = "/og-default.png",
    url = Astro.site?.origin || new URL(Astro.request.url).origin,
    type = "website",
    publishedTime,
    modifiedTime,
    tags = [],
    author = "Malcolm Bastien",
} = Astro.props;

// Generate canonical URL
const canonicalUrl = new URL(Astro.url.pathname, Astro.site || url).href;

// Generate Open Graph image URL
const ogImage = image.startsWith("http") ? image : url + image;
---

<html lang="en">
    <head>
        <meta charset="utf-8" />
        <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
        <meta name="viewport" content="width=device-width" />
        <meta name="generator" content={Astro.generator} />
        <meta name="fediverse:creator" content="@malcolm@mastodon.social" />

        <!-- Flow Focused Fonts v1.1 -->
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesk:opsz,wght@12..96,200..1000&family=IBM+Plex+Mono:ital,wght@0,100..700;1,100..700&family=Playfair+Display:ital,wght@0,400..900;1,400..900&family=Public+Sans:ital,wght@0,100..900;1,100..900&display=swap"
            rel="stylesheet"
        />

        <!-- Primary Meta Tags -->
        <title>{title}</title>
        <meta name="title" content={title} />
        <meta name="description" content={description} />
        <meta name="author" content={author} />
        <link rel="canonical" href={canonicalUrl} />

        <!-- Open Graph / Facebook -->
        <meta property="og:type" content={type} />
        <meta property="og:url" content={canonicalUrl} />
        <meta property="og:title" content={title} />
        <meta property="og:description" content={description} />
        <meta property="og:image" content={ogImage} />
        <meta property="og:site_name" content="Sprout" />

        <!-- Twitter -->
        <meta property="twitter:card" content="summary_large_image" />
        <meta property="twitter:url" content={canonicalUrl} />
        <meta property="twitter:title" content={title} />
        <meta property="twitter:description" content={description} />
        <meta property="twitter:image" content={ogImage} />

        <!-- Additional SEO -->
        <meta name="robots" content="index, follow" />
        <meta name="language" content="English" />
        {tags.map((tag) => <meta property="article:tag" content={tag} />)}

        <!-- Article specific (only for article type) -->
        {
            type === "article" && publishedTime && (
                <meta
                    property="article:published_time"
                    content={publishedTime}
                />
            )
        }
        {
            type === "article" && modifiedTime && (
                <meta property="article:modified_time" content={modifiedTime} />
            )
        }
        {
            type === "article" && (
                <meta property="article:author" content={author} />
            )
        }

        <!-- Structured Data -->
        <script
            type="application/ld+json"
            set:html={JSON.stringify({
                "@context": "https://schema.org",
                "@type": type === "article" ? "BlogPosting" : "WebSite",
                name: title,
                description: description,
                url: canonicalUrl,
                image: ogImage,
                author: {
                    "@type": "Person",
                    name: author,
                },
                publisher: {
                    "@type": "Organization",
                    name: "Sprout",
                    url: url,
                },
                ...(type === "article" &&
                    publishedTime && { datePublished: publishedTime }),
                ...(type === "article" &&
                    modifiedTime && { dateModified: modifiedTime }),
                ...(type === "article" &&
                    tags.length > 0 && { keywords: tags.join(", ") }),
            })}
        />

        <slot name="head" />

        <script is:inline>
            const theme = (() => {
                if (
                    typeof localStorage !== "undefined" &&
                    localStorage.getItem("theme")
                ) {
                    return localStorage.getItem("theme");
                }
                if (window.matchMedia("(prefers-color-scheme: dark)").matches) {
                    return "dark";
                }
                return "light";
            })();

            if (theme === "light") {
                document.documentElement.classList.remove("dark");
            } else {
                document.documentElement.classList.add("dark");
            }
            window.localStorage.setItem("theme", theme);
        </script>
    </head>
    <body
        class="bg-white dark:bg-[#0f172a] text-[#0f172a] dark:text-white antialiased min-h-screen"
    >
        <header class="sticky top-0 z-50 bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-slate-700">
            <div class="max-w-(--breakpoint-2xl) mx-auto px-4 py-6">
                <nav class="flex items-center justify-between">
                    <div class="flex items-center gap-8">
                        <a href="/" class="flex items-center gap-3 group">
                            <div class="w-8 h-8 bg-blueprint-blue rounded"></div>
                            <div class="flex flex-col">
                                <span class="font-bold text-terminal-dark dark:text-white group-hover:text-blueprint-blue transition-colors">Malcolm Bastien</span>
                                <span class="text-xs text-slate-500 dark:text-slate-400">Digital Garden</span>
                            </div>
                        </a>
                        <div class="hidden md:flex items-center gap-6">
                            <a href="/" class="text-sm font-medium text-slate-600 dark:text-slate-400 hover:text-terminal-dark dark:hover:text-white transition-colors">Home</a>
                            <a href="/about" class="text-sm font-medium text-slate-600 dark:text-slate-400 hover:text-terminal-dark dark:hover:text-white transition-colors">About</a>
                        </div>
                    </div>
                    <ThemeToggle client:load />
                </nav>
            </div>
        </header>
        <slot />
    </body>
</html>
