---
import "../styles/global.css";
import ThemeToggle from "../components/ThemeToggle.astro";

interface Props {
    title: string;
    description?: string;
    image?: string;
    url?: string;
    type?: "website" | "article";
    publishedTime?: string;
    modifiedTime?: string;
    tags?: string[];
    author?: string;
}

const {
    title,
    description = "A digital garden of thoughts and ideas",
    image = "/og-default.png",
    url = Astro.site?.origin || new URL(Astro.request.url).origin,
    type = "website",
    publishedTime,
    modifiedTime,
    tags = [],
    author = "Malcolm Bastien",
} = Astro.props;

// Generate canonical URL
const canonicalUrl = new URL(Astro.url.pathname, Astro.site || url).href;

// Generate Open Graph image URL
const ogImage = image.startsWith("http") ? image : url + image;


const currentPath = Astro.url.pathname;

const navItems = [
    { href: "/", label: "Garden" },
    { href: "/topics", label: "Topics" },
    { href: "/search", label: "Search" },
    { href: "/colophon", label: "Colophon" },
    { href: "/about", label: "About" },
];
---

<html lang="en">
    <head>
        <meta charset="utf-8" />
        <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
        <meta name="viewport" content="width=device-width" />
        <meta name="generator" content={Astro.generator} />
        <meta name="fediverse:creator" content="@malcolm@mastodon.social" />

        <!-- Flow Focused Fonts v1.1 -->
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesk:opsz,wght@12..96,200..1000&family=IBM+Plex+Mono:ital,wght@0,100..700;1,100..700&family=Playfair+Display:ital,wght@0,400..900;1,400..900&family=Public+Sans:ital,wght@0,100..900;1,100..900&display=swap"
            rel="stylesheet"
        />

        <!-- Primary Meta Tags -->
        <title>{title}</title>
        <meta name="title" content={title} />
        <meta name="description" content={description} />
        <meta name="author" content={author} />
        <link rel="canonical" href={canonicalUrl} />

        <!-- Open Graph / Facebook -->
        <meta property="og:type" content={type} />
        <meta property="og:url" content={canonicalUrl} />
        <meta property="og:title" content={title} />
        <meta property="og:description" content={description} />
        <meta property="og:image" content={ogImage} />
        <meta property="og:site_name" content="Sprout" />

        <!-- Twitter -->
        <meta property="twitter:card" content="summary_large_image" />
        <meta property="twitter:url" content={canonicalUrl} />
        <meta property="twitter:title" content={title} />
        <meta property="twitter:description" content={description} />
        <meta property="twitter:image" content={ogImage} />

        <!-- Additional SEO -->
        <meta name="robots" content="index, follow" />
        <meta name="language" content="English" />
        {tags.map((tag) => <meta property="article:tag" content={tag} />)}

        <!-- Article specific (only for article type) -->
        {
            type === "article" && publishedTime && (
                <meta
                    property="article:published_time"
                    content={publishedTime}
                />
            )
        }
        {
            type === "article" && modifiedTime && (
                <meta property="article:modified_time" content={modifiedTime} />
            )
        }
        {
            type === "article" && (
                <meta property="article:author" content={author} />
            )
        }

        <!-- Structured Data -->
        <script
            is:inline
            type="application/ld+json"
            set:html={JSON.stringify({
                "@context": "https://schema.org",
                "@type": type === "article" ? "BlogPosting" : "WebSite",
                name: title,
                description: description,
                url: canonicalUrl,
                image: ogImage,
                author: {
                    "@type": "Person",
                    name: author,
                },
                publisher: {
                    "@type": "Organization",
                    name: "Sprout",
                    url: url,
                },
                ...(type === "article" &&
                    publishedTime && { datePublished: publishedTime }),
                ...(type === "article" &&
                    modifiedTime && { dateModified: modifiedTime }),
                ...(type === "article" &&
                    tags.length > 0 && { keywords: tags.join(", ") }),
            })}
        />

        <slot name="head" />

        <script is:inline>
            const theme = (() => {
                if (
                    typeof localStorage !== "undefined" &&
                    localStorage.getItem("theme")
                ) {
                    return localStorage.getItem("theme");
                }
                if (window.matchMedia("(prefers-color-scheme: dark)").matches) {
                    return "dark";
                }
                return "light";
            })();

            if (theme === "light") {
                document.documentElement.classList.remove("dark");
            } else {
                document.documentElement.classList.add("dark");
            }
            window.localStorage.setItem("theme", theme);
        </script>
    </head>
    <body
        class="bg-white dark:bg-terminal-dark text-terminal-dark dark:text-white antialiased min-h-screen"
    >
        <header class="max-w-7xl mx-auto px-6 md:px-12 pt-6 pb-6">
            <div class="flex flex-col md:flex-row justify-between items-center gap-6 md:gap-10">
                <a href="/" class="flex items-center gap-2 md:gap-3">
                    <span class="font-mono uppercase tracking-widest text-blueprint-blue font-extrabold text-sm md:text-base">
                        Malcolm Bastien
                    </span>
                    <span class="hidden sm:block h-3 w-px bg-slate-200 dark:bg-slate-700"></span>
                    <span class="hidden sm:inline font-mono font-medium uppercase tracking-widest opacity-50 text-sm md:text-base">
                        Flow Focused ðŸŒŠ
                    </span>
                </a>

                <div class="flex items-center gap-2 md:gap-4 w-full md:w-auto">
                    <nav class="flex items-center font-medium gap-1 md:gap-2 border-b border-slate-100 dark:border-slate-800 flex-1 md:flex-none justify-center md:justify-end mt-0.5 overflow-x-auto no-scrollbar">
                        {navItems.map((item) => (
                            <a
                                href={item.href}
                                class:list={[
                                    "relative text-xs md:text-sm tracking-wide px-2.5 md:px-4 py-2 transition-all shrink-0",
                                    currentPath.replace(/\/$/, '') === item.href.replace(/\/$/, '')
                                        ? "text-primary font-extrabold after:content-[''] after:absolute after:bottom-0.5 after:left-2.5 md:after:left-4 after:right-2.5 md:after:right-4 after:h-0.75 after:bg-blueprint-blue"
                                        : "text-secondary hover:text-blueprint-blue dark:hover:text-white"
                                ]}
                            >
                                {item.label}
                            </a>
                        ))}
                    </nav>
                    <div class="w-px h-4 bg-slate-200 dark:bg-slate-700 shrink-0"></div>
                    <ThemeToggle />
                </div>
            </div>
        </header>
        <slot />
    </body>
</html>
